// This Pine Script® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
//@version=5
strategy("RSI & VFI Стратегия + ADX + HH/LH [Long+Short]", overlay=true,
         initial_capital=10000, pyramiding=2,
         default_qty_type=strategy.percent_of_equity, default_qty_value=100,
         close_entries_rule="ANY")

// ═══════════════════════════════════════════════════════════════════════════
// МАСТЕР-ВЫКЛЮЧАТЕЛИ НАПРАВЛЕНИЙ
// ═══════════════════════════════════════════════════════════════════════════

enableLong  = input.bool(true,  "Включить ЛОНГ",  group="Направления")
enableShort = input.bool(true,  "Включить ШОРТ",  group="Направления")
allowFlip   = input.bool(true,  "Разрешить переворот позиции (закрыть текущую и открыть противоположную)", group="Направления")

// ═══════════════════════════════════════════════════════════════════════════
// НАСТРОЙКИ ИНДИКАТОРОВ
// ═══════════════════════════════════════════════════════════════════════════

rsiPeriod      = 14
vfiLength      = 130
vfiCoef        = 0.2
vfiVcoef       = 2.5
minRedCandles  = input.int(3,   "Мин. красных свечей перед покупкой (Лонг) / зелёных перед продажей (Шорт)", minval=1)
signalWindowLong  = input.int(5, "Окно поиска сигнала при выходе из Лонга",  minval=0)
signalWindowShort = input.int(5, "Окно поиска сигнала при выходе из Шорта", minval=0)

showTable  = input.bool(true, "Показывать таблицу",  group="Отображение")
showLabels = input.bool(true, "Показывать метки",     group="Отображение")

// ═══════════════════════════════════════════════════════════════════════════
// ADX CALCULATION (used in entry/exit conditions, not as global filter)
// ═══════════════════════════════════════════════════════════════════════════

adxLen = 14  // Fixed period for ADX/DI calculation

// ═══════════════════════════════════════════════════════════════════════════
// ЧЕТЫРЕ ПИВОТ-ФИЛЬТРА (HH/LH/HL/LL)
// ═══════════════════════════════════════════════════════════════════════════

// Пивот-фильтр: Закрытие Лонга
usePivotFilterLongExit   = input.bool(true,   "Включить фильтр",                        group="HH/LH Фильтр: Закрытие Лонга")
pivotLongExitFirst       = input.string("HH", "Первый пивот",  options=["HH","LH","HL","LL"], group="HH/LH Фильтр: Закрытие Лонга")
pivotLongExitSecond      = input.string("LH", "Второй пивот",  options=["HH","LH","HL","LL"], group="HH/LH Фильтр: Закрытие Лонга")
pivotLongExitWinBack     = input.int(5,       "Окно назад (свечей)", minval=0,          group="HH/LH Фильтр: Закрытие Лонга")
pivotLongExitWinFwd      = input.int(5,       "Окно вперёд (свечей)", minval=0,         group="HH/LH Фильтр: Закрытие Лонга")

// Пивот-фильтр: Открытие Лонга
usePivotFilterLongEntry  = input.bool(false,  "Включить фильтр",                        group="HH/LH Фильтр: Открытие Лонга")
pivotLongEntryFirst      = input.string("LL", "Первый пивот",  options=["HH","LH","HL","LL"], group="HH/LH Фильтр: Открытие Лонга")
pivotLongEntrySecond     = input.string("HL", "Второй пивот",  options=["HH","LH","HL","LL"], group="HH/LH Фильтр: Открытие Лонга")
pivotLongEntryWinBack    = input.int(5,       "Окно назад (свечей)", minval=0,          group="HH/LH Фильтр: Открытие Лонга")
pivotLongEntryWinFwd     = input.int(5,       "Окно вперёд (свечей)", minval=0,         group="HH/LH Фильтр: Открытие Лонга")

// Пивот-фильтр: Закрытие Шорта
usePivotFilterShortExit  = input.bool(true,   "Включить фильтр",                        group="HH/LH Фильтр: Закрытие Шорта")
pivotShortExitFirst      = input.string("LL", "Первый пивот",  options=["HH","LH","HL","LL"], group="HH/LH Фильтр: Закрытие Шорта")
pivotShortExitSecond     = input.string("HL", "Второй пивот",  options=["HH","LH","HL","LL"], group="HH/LH Фильтр: Закрытие Шорта")
pivotShortExitWinBack    = input.int(5,       "Окно назад (свечей)", minval=0,          group="HH/LH Фильтр: Закрытие Шорта")
pivotShortExitWinFwd     = input.int(5,       "Окно вперёд (свечей)", minval=0,         group="HH/LH Фильтр: Закрытие Шорта")

// Пивот-фильтр: Открытие Шорта
usePivotFilterShortEntry = input.bool(false,  "Включить фильтр",                        group="HH/LH Фильтр: Открытие Шорта")
pivotShortEntryFirst     = input.string("HH", "Первый пивот",  options=["HH","LH","HL","LL"], group="HH/LH Фильтр: Открытие Шорта")
pivotShortEntrySecond    = input.string("LH", "Второй пивот",  options=["HH","LH","HL","LL"], group="HH/LH Фильтр: Открытие Шорта")
pivotShortEntryWinBack   = input.int(5,       "Окно назад (свечей)", minval=0,          group="HH/LH Фильтр: Открытие Шорта")
pivotShortEntryWinFwd    = input.int(5,       "Окно вперёд (свечей)", minval=0,         group="HH/LH Фильтр: Открытие Шорта")

// ═══════════════════════════════════════════════════════════════════════════
// ЛОНГ — НАСТРОЙКИ ВХОДА
// ═══════════════════════════════════════════════════════════════════════════

enableLB1  = input.bool(true,  "LB1: RSI+VFI", group="[ЛОНГ] Покупка: RSI+VFI", inline="lb1")
lb1RsiOp   = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Покупка: RSI+VFI", inline="lb1")
lb1RsiVal  = input.float(30,  "RSI",                    group="[ЛОНГ] Покупка: RSI+VFI", inline="lb1")
lb1VfiOp   = input.string(">","VFI",  options=["<",">"], group="[ЛОНГ] Покупка: RSI+VFI", inline="lb1")
lb1VfiVal  = input.float(10,  "",                       group="[ЛОНГ] Покупка: RSI+VFI", inline="lb1")

enableLB2  = input.bool(true,  "LB2: RSI+VFI", group="[ЛОНГ] Покупка: RSI+VFI", inline="lb2")
lb2RsiOp   = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Покупка: RSI+VFI", inline="lb2")
lb2RsiVal  = input.float(25,  "RSI",                    group="[ЛОНГ] Покупка: RSI+VFI", inline="lb2")
lb2VfiOp   = input.string(">","VFI",  options=["<",">"], group="[ЛОНГ] Покупка: RSI+VFI", inline="lb2")
lb2VfiVal  = input.float(15,  "",                       group="[ЛОНГ] Покупка: RSI+VFI", inline="lb2")

enableLB3  = input.bool(true,  "LB3: RSI+VFI", group="[ЛОНГ] Покупка: RSI+VFI", inline="lb3")
lb3RsiOp   = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Покупка: RSI+VFI", inline="lb3")
lb3RsiVal  = input.float(35,  "RSI",                    group="[ЛОНГ] Покупка: RSI+VFI", inline="lb3")
lb3VfiOp   = input.string(">","VFI",  options=["<",">"], group="[ЛОНГ] Покупка: RSI+VFI", inline="lb3")
lb3VfiVal  = input.float(5,   "",                       group="[ЛОНГ] Покупка: RSI+VFI", inline="lb3")

enableLB4  = input.bool(true,  "LB4: RSI+VFI", group="[ЛОНГ] Покупка: RSI+VFI", inline="lb4")
lb4RsiOp   = input.string(">", "",    options=["<",">"], group="[ЛОНГ] Покупка: RSI+VFI", inline="lb4")
lb4RsiVal  = input.float(60,  "RSI",                    group="[ЛОНГ] Покупка: RSI+VFI", inline="lb4")
lb4VfiOp   = input.string(">","VFI",  options=["<",">"], group="[ЛОНГ] Покупка: RSI+VFI", inline="lb4")
lb4VfiVal  = input.float(10,  "",                       group="[ЛОНГ] Покупка: RSI+VFI", inline="lb4")

enableLB5  = input.bool(true,  "LB5: RSI",  group="[ЛОНГ] Покупка: Только RSI", inline="lb5")
lb5RsiOp   = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Покупка: Только RSI", inline="lb5")
lb5RsiVal  = input.float(30,  "RSI",                    group="[ЛОНГ] Покупка: Только RSI", inline="lb5")

enableLB6  = input.bool(true,  "LB6: RSI",  group="[ЛОНГ] Покупка: Только RSI", inline="lb6")
lb6RsiOp   = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Покупка: Только RSI", inline="lb6")
lb6RsiVal  = input.float(25,  "RSI",                    group="[ЛОНГ] Покупка: Только RSI", inline="lb6")

enableLB7  = input.bool(true,  "LB7: RSI",  group="[ЛОНГ] Покупка: Только RSI", inline="lb7")
lb7RsiOp   = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Покупка: Только RSI", inline="lb7")
lb7RsiVal  = input.float(20,  "RSI",                    group="[ЛОНГ] Покупка: Только RSI", inline="lb7")

enableLB8  = input.bool(true,  "LB8: RSI",  group="[ЛОНГ] Покупка: Только RSI", inline="lb8")
lb8RsiOp   = input.string(">", "",    options=["<",">"], group="[ЛОНГ] Покупка: Только RSI", inline="lb8")
lb8RsiVal  = input.float(60,  "RSI",                    group="[ЛОНГ] Покупка: Только RSI", inline="lb8")

enableLB9  = input.bool(true,  "LB9:  VFI", group="[ЛОНГ] Покупка: Только VFI", inline="lb9")
lb9VfiOp   = input.string(">", "",    options=["<",">"], group="[ЛОНГ] Покупка: Только VFI", inline="lb9")
lb9VfiVal  = input.float(5,   "VFI",                    group="[ЛОНГ] Покупка: Только VFI", inline="lb9")

enableLB10 = input.bool(true,  "LB10: VFI", group="[ЛОНГ] Покупка: Только VFI", inline="lb10")
lb10VfiOp  = input.string(">", "",    options=["<",">"], group="[ЛОНГ] Покупка: Только VFI", inline="lb10")
lb10VfiVal = input.float(10,  "VFI",                    group="[ЛОНГ] Покупка: Только VFI", inline="lb10")

enableLB11 = input.bool(true,  "LB11: VFI", group="[ЛОНГ] Покупка: Только VFI", inline="lb11")
lb11VfiOp  = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Покупка: Только VFI", inline="lb11")
lb11VfiVal = input.float(-5,  "VFI",                    group="[ЛОНГ] Покупка: Только VFI", inline="lb11")

enableLB12 = input.bool(true,  "LB12: VFI", group="[ЛОНГ] Покупка: Только VFI", inline="lb12")
lb12VfiOp  = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Покупка: Только VFI", inline="lb12")
lb12VfiVal = input.float(-10, "VFI",                    group="[ЛОНГ] Покупка: Только VFI", inline="lb12")

enableLB13  = input.bool(false, "LB13a: DI+",        group="[ЛОНГ] Покупка: С DI+", inline="lb13a")
lb13AdxOp   = input.string("<", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb13a")
lb13AdxVal  = input.float(20,  "DI+",                group="[ЛОНГ] Покупка: С DI+", inline="lb13a")

enableLB13b = input.bool(false, "LB13b: DI+",        group="[ЛОНГ] Покупка: С DI+", inline="lb13b")
lb13bAdxOp  = input.string(">", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb13b")
lb13bAdxVal = input.float(25,  "DI+",                group="[ЛОНГ] Покупка: С DI+", inline="lb13b")

enableLB14  = input.bool(false, "LB14a: RSI+DI+",    group="[ЛОНГ] Покупка: С DI+", inline="lb14a")
lb14RsiOp   = input.string("<", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb14a")
lb14RsiVal  = input.float(30,  "RSI",                group="[ЛОНГ] Покупка: С DI+", inline="lb14a")
lb14AdxOp   = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb14a")
lb14AdxVal  = input.float(20,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb14a")

enableLB14b = input.bool(false, "LB14b: RSI+DI+",    group="[ЛОНГ] Покупка: С DI+", inline="lb14b")
lb14bRsiOp  = input.string("<", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb14b")
lb14bRsiVal = input.float(25,  "RSI",                group="[ЛОНГ] Покупка: С DI+", inline="lb14b")
lb14bAdxOp  = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb14b")
lb14bAdxVal = input.float(25,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb14b")

enableLB14c = input.bool(false, "LB14c: RSI+DI+",    group="[ЛОНГ] Покупка: С DI+", inline="lb14c")
lb14cRsiOp  = input.string(">", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb14c")
lb14cRsiVal = input.float(60,  "RSI",                group="[ЛОНГ] Покупка: С DI+", inline="lb14c")
lb14cAdxOp  = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb14c")
lb14cAdxVal = input.float(25,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb14c")

enableLB14d = input.bool(false, "LB14d: RSI+DI+",    group="[ЛОНГ] Покупка: С DI+", inline="lb14d")
lb14dRsiOp  = input.string(">", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb14d")
lb14dRsiVal = input.float(70,  "RSI",                group="[ЛОНГ] Покупка: С DI+", inline="lb14d")
lb14dAdxOp  = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb14d")
lb14dAdxVal = input.float(30,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb14d")

enableLB15  = input.bool(false, "LB15a: VFI+DI+",   group="[ЛОНГ] Покупка: С DI+", inline="lb15a")
lb15VfiOp   = input.string(">", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb15a")
lb15VfiVal  = input.float(5,   "VFI",                group="[ЛОНГ] Покупка: С DI+", inline="lb15a")
lb15AdxOp   = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb15a")
lb15AdxVal  = input.float(20,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb15a")

enableLB15b = input.bool(false, "LB15b: VFI+DI+",   group="[ЛОНГ] Покупка: С DI+", inline="lb15b")
lb15bVfiOp  = input.string(">", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb15b")
lb15bVfiVal = input.float(10,  "VFI",                group="[ЛОНГ] Покупка: С DI+", inline="lb15b")
lb15bAdxOp  = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb15b")
lb15bAdxVal = input.float(25,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb15b")

enableLB15c = input.bool(false, "LB15c: VFI+DI+",   group="[ЛОНГ] Покупка: С DI+", inline="lb15c")
lb15cVfiOp  = input.string("<", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb15c")
lb15cVfiVal = input.float(-5,  "VFI",                group="[ЛОНГ] Покупка: С DI+", inline="lb15c")
lb15cAdxOp  = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb15c")
lb15cAdxVal = input.float(25,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb15c")

enableLB15d = input.bool(false, "LB15d: VFI+DI+",   group="[ЛОНГ] Покупка: С DI+", inline="lb15d")
lb15dVfiOp  = input.string("<", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb15d")
lb15dVfiVal = input.float(-10, "VFI",                group="[ЛОНГ] Покупка: С DI+", inline="lb15d")
lb15dAdxOp  = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb15d")
lb15dAdxVal = input.float(30,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb15d")

enableLB16  = input.bool(false, "LB16a: RSI+VFI+DI+", group="[ЛОНГ] Покупка: С DI+", inline="lb16a")
lb16RsiOp   = input.string("<", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16a")
lb16RsiVal  = input.float(30,  "RSI",                group="[ЛОНГ] Покупка: С DI+", inline="lb16a")
lb16VfiOp   = input.string(">", "VFI", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16a")
lb16VfiVal  = input.float(5,   "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb16a")
lb16AdxOp   = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16a")
lb16AdxVal  = input.float(20,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb16a")

enableLB16b = input.bool(false, "LB16b: RSI+VFI+DI+", group="[ЛОНГ] Покупка: С DI+", inline="lb16b")
lb16bRsiOp  = input.string("<", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16b")
lb16bRsiVal = input.float(25,  "RSI",                group="[ЛОНГ] Покупка: С DI+", inline="lb16b")
lb16bVfiOp  = input.string(">", "VFI", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16b")
lb16bVfiVal = input.float(10,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb16b")
lb16bAdxOp  = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16b")
lb16bAdxVal = input.float(25,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb16b")

enableLB16c = input.bool(false, "LB16c: RSI+VFI+DI+", group="[ЛОНГ] Покупка: С DI+", inline="lb16c")
lb16cRsiOp  = input.string(">", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16c")
lb16cRsiVal = input.float(60,  "RSI",                group="[ЛОНГ] Покупка: С DI+", inline="lb16c")
lb16cVfiOp  = input.string(">", "VFI", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16c")
lb16cVfiVal = input.float(10,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb16c")
lb16cAdxOp  = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16c")
lb16cAdxVal = input.float(25,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb16c")

enableLB16d = input.bool(false, "LB16d: RSI+VFI+DI+", group="[ЛОНГ] Покупка: С DI+", inline="lb16d")
lb16dRsiOp  = input.string(">", "", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16d")
lb16dRsiVal = input.float(70,  "RSI",                group="[ЛОНГ] Покупка: С DI+", inline="lb16d")
lb16dVfiOp  = input.string(">", "VFI", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16d")
lb16dVfiVal = input.float(15,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb16d")
lb16dAdxOp  = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Покупка: С DI+", inline="lb16d")
lb16dAdxVal = input.float(30,  "",                   group="[ЛОНГ] Покупка: С DI+", inline="lb16d")

// ═══════════════════════════════════════════════════════════════════════════
// ЛОНГ — НАСТРОЙКИ ПРОДАЖИ
// ═══════════════════════════════════════════════════════════════════════════

enableLS1  = input.bool(true,  "LS1: RSI+VFI", group="[ЛОНГ] Продажа: RSI+VFI", inline="ls1")
ls1RsiOp   = input.string(">", "",    options=["<",">"], group="[ЛОНГ] Продажа: RSI+VFI", inline="ls1")
ls1RsiVal  = input.float(70,  "RSI",                    group="[ЛОНГ] Продажа: RSI+VFI", inline="ls1")
ls1VfiOp   = input.string("<","VFI",  options=["<",">"], group="[ЛОНГ] Продажа: RSI+VFI", inline="ls1")
ls1VfiVal  = input.float(-5,  "",                       group="[ЛОНГ] Продажа: RSI+VFI", inline="ls1")

enableLS2  = input.bool(true,  "LS2: RSI+VFI", group="[ЛОНГ] Продажа: RSI+VFI", inline="ls2")
ls2RsiOp   = input.string(">", "",    options=["<",">"], group="[ЛОНГ] Продажа: RSI+VFI", inline="ls2")
ls2RsiVal  = input.float(75,  "RSI",                    group="[ЛОНГ] Продажа: RSI+VFI", inline="ls2")
ls2VfiOp   = input.string("<","VFI",  options=["<",">"], group="[ЛОНГ] Продажа: RSI+VFI", inline="ls2")
ls2VfiVal  = input.float(-10, "",                       group="[ЛОНГ] Продажа: RSI+VFI", inline="ls2")

enableLS3  = input.bool(true,  "LS3: RSI+VFI", group="[ЛОНГ] Продажа: RSI+VFI", inline="ls3")
ls3RsiOp   = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Продажа: RSI+VFI", inline="ls3")
ls3RsiVal  = input.float(30,  "RSI",                    group="[ЛОНГ] Продажа: RSI+VFI", inline="ls3")
ls3VfiOp   = input.string(">","VFI",  options=["<",">"], group="[ЛОНГ] Продажа: RSI+VFI", inline="ls3")
ls3VfiVal  = input.float(10,  "",                       group="[ЛОНГ] Продажа: RSI+VFI", inline="ls3")

enableLS4  = input.bool(true,  "LS4: RSI+VFI", group="[ЛОНГ] Продажа: RSI+VFI", inline="ls4")
ls4RsiOp   = input.string(">", "",    options=["<",">"], group="[ЛОНГ] Продажа: RSI+VFI", inline="ls4")
ls4RsiVal  = input.float(65,  "RSI",                    group="[ЛОНГ] Продажа: RSI+VFI", inline="ls4")
ls4VfiOp   = input.string("<","VFI",  options=["<",">"], group="[ЛОНГ] Продажа: RSI+VFI", inline="ls4")
ls4VfiVal  = input.float(0,   "",                       group="[ЛОНГ] Продажа: RSI+VFI", inline="ls4")

enableLS5  = input.bool(true,  "LS5: RSI",  group="[ЛОНГ] Продажа: Только RSI", inline="ls5")
ls5RsiOp   = input.string(">", "",    options=["<",">"], group="[ЛОНГ] Продажа: Только RSI", inline="ls5")
ls5RsiVal  = input.float(70,  "RSI",                    group="[ЛОНГ] Продажа: Только RSI", inline="ls5")

enableLS6  = input.bool(true,  "LS6: RSI",  group="[ЛОНГ] Продажа: Только RSI", inline="ls6")
ls6RsiOp   = input.string(">", "",    options=["<",">"], group="[ЛОНГ] Продажа: Только RSI", inline="ls6")
ls6RsiVal  = input.float(80,  "RSI",                    group="[ЛОНГ] Продажа: Только RSI", inline="ls6")

enableLS7  = input.bool(true,  "LS7: RSI",  group="[ЛОНГ] Продажа: Только RSI", inline="ls7")
ls7RsiOp   = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Продажа: Только RSI", inline="ls7")
ls7RsiVal  = input.float(30,  "RSI",                    group="[ЛОНГ] Продажа: Только RSI", inline="ls7")

enableLS8  = input.bool(true,  "LS8: RSI",  group="[ЛОНГ] Продажа: Только RSI", inline="ls8")
ls8RsiOp   = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Продажа: Только RSI", inline="ls8")
ls8RsiVal  = input.float(25,  "RSI",                    group="[ЛОНГ] Продажа: Только RSI", inline="ls8")

enableLS9  = input.bool(true,  "LS9:  VFI", group="[ЛОНГ] Продажа: Только VFI", inline="ls9")
ls9VfiOp   = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Продажа: Только VFI", inline="ls9")
ls9VfiVal  = input.float(-5,  "VFI",                    group="[ЛОНГ] Продажа: Только VFI", inline="ls9")

enableLS10 = input.bool(true,  "LS10: VFI", group="[ЛОНГ] Продажа: Только VFI", inline="ls10")
ls10VfiOp  = input.string("<", "",    options=["<",">"], group="[ЛОНГ] Продажа: Только VFI", inline="ls10")
ls10VfiVal = input.float(-10, "VFI",                    group="[ЛОНГ] Продажа: Только VFI", inline="ls10")

enableLS11 = input.bool(true,  "LS11: VFI", group="[ЛОНГ] Продажа: Только VFI", inline="ls11")
ls11VfiOp  = input.string(">", "",    options=["<",">"], group="[ЛОНГ] Продажа: Только VFI", inline="ls11")
ls11VfiVal = input.float(5,   "VFI",                    group="[ЛОНГ] Продажа: Только VFI", inline="ls11")

enableLS12 = input.bool(true,  "LS12: VFI", group="[ЛОНГ] Продажа: Только VFI", inline="ls12")
ls12VfiOp  = input.string(">", "",    options=["<",">"], group="[ЛОНГ] Продажа: Только VFI", inline="ls12")
ls12VfiVal = input.float(10,  "VFI",                    group="[ЛОНГ] Продажа: Только VFI", inline="ls12")

enableLS13  = input.bool(false, "LS13a: DI+",        group="[ЛОНГ] Продажа: С DI+", inline="ls13a")
ls13DiOp    = input.string("<", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls13a")
ls13DiVal   = input.float(20,  "DI+",                group="[ЛОНГ] Продажа: С DI+", inline="ls13a")

enableLS13b = input.bool(false, "LS13b: DI+",        group="[ЛОНГ] Продажа: С DI+", inline="ls13b")
ls13bDiOp   = input.string(">", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls13b")
ls13bDiVal  = input.float(25,  "DI+",                group="[ЛОНГ] Продажа: С DI+", inline="ls13b")

enableLS14  = input.bool(false, "LS14a: RSI+DI+",    group="[ЛОНГ] Продажа: С DI+", inline="ls14a")
ls14RsiOp   = input.string(">", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls14a")
ls14RsiVal  = input.float(70,  "RSI",                group="[ЛОНГ] Продажа: С DI+", inline="ls14a")
ls14DiOp    = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls14a")
ls14DiVal   = input.float(20,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls14a")

enableLS14b = input.bool(false, "LS14b: RSI+DI+",    group="[ЛОНГ] Продажа: С DI+", inline="ls14b")
ls14bRsiOp  = input.string(">", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls14b")
ls14bRsiVal = input.float(75,  "RSI",                group="[ЛОНГ] Продажа: С DI+", inline="ls14b")
ls14bDiOp   = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls14b")
ls14bDiVal  = input.float(25,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls14b")

enableLS14c = input.bool(false, "LS14c: RSI+DI+",    group="[ЛОНГ] Продажа: С DI+", inline="ls14c")
ls14cRsiOp  = input.string("<", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls14c")
ls14cRsiVal = input.float(30,  "RSI",                group="[ЛОНГ] Продажа: С DI+", inline="ls14c")
ls14cDiOp   = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls14c")
ls14cDiVal  = input.float(25,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls14c")

enableLS14d = input.bool(false, "LS14d: RSI+DI+",    group="[ЛОНГ] Продажа: С DI+", inline="ls14d")
ls14dRsiOp  = input.string("<", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls14d")
ls14dRsiVal = input.float(25,  "RSI",                group="[ЛОНГ] Продажа: С DI+", inline="ls14d")
ls14dDiOp   = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls14d")
ls14dDiVal  = input.float(30,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls14d")

enableLS15  = input.bool(false, "LS15a: VFI+DI+",   group="[ЛОНГ] Продажа: С DI+", inline="ls15a")
ls15VfiOp   = input.string("<", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls15a")
ls15VfiVal  = input.float(-5,  "VFI",                group="[ЛОНГ] Продажа: С DI+", inline="ls15a")
ls15DiOp    = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls15a")
ls15DiVal   = input.float(20,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls15a")

enableLS15b = input.bool(false, "LS15b: VFI+DI+",   group="[ЛОНГ] Продажа: С DI+", inline="ls15b")
ls15bVfiOp  = input.string("<", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls15b")
ls15bVfiVal = input.float(-10, "VFI",                group="[ЛОНГ] Продажа: С DI+", inline="ls15b")
ls15bDiOp   = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls15b")
ls15bDiVal  = input.float(25,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls15b")

enableLS15c = input.bool(false, "LS15c: VFI+DI+",   group="[ЛОНГ] Продажа: С DI+", inline="ls15c")
ls15cVfiOp  = input.string(">", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls15c")
ls15cVfiVal = input.float(5,   "VFI",                group="[ЛОНГ] Продажа: С DI+", inline="ls15c")
ls15cDiOp   = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls15c")
ls15cDiVal  = input.float(25,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls15c")

enableLS15d = input.bool(false, "LS15d: VFI+DI+",   group="[ЛОНГ] Продажа: С DI+", inline="ls15d")
ls15dVfiOp  = input.string(">", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls15d")
ls15dVfiVal = input.float(10,  "VFI",                group="[ЛОНГ] Продажа: С DI+", inline="ls15d")
ls15dDiOp   = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls15d")
ls15dDiVal  = input.float(30,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls15d")

enableLS16  = input.bool(false, "LS16a: RSI+VFI+DI+", group="[ЛОНГ] Продажа: С DI+", inline="ls16a")
ls16RsiOp   = input.string(">", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16a")
ls16RsiVal  = input.float(70,  "RSI",                group="[ЛОНГ] Продажа: С DI+", inline="ls16a")
ls16VfiOp   = input.string("<", "VFI", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16a")
ls16VfiVal  = input.float(-5,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls16a")
ls16DiOp    = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16a")
ls16DiVal   = input.float(20,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls16a")

enableLS16b = input.bool(false, "LS16b: RSI+VFI+DI+", group="[ЛОНГ] Продажа: С DI+", inline="ls16b")
ls16bRsiOp  = input.string(">", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16b")
ls16bRsiVal = input.float(75,  "RSI",                group="[ЛОНГ] Продажа: С DI+", inline="ls16b")
ls16bVfiOp  = input.string("<", "VFI", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16b")
ls16bVfiVal = input.float(-10, "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls16b")
ls16bDiOp   = input.string("<", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16b")
ls16bDiVal  = input.float(25,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls16b")

enableLS16c = input.bool(false, "LS16c: RSI+VFI+DI+", group="[ЛОНГ] Продажа: С DI+", inline="ls16c")
ls16cRsiOp  = input.string("<", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16c")
ls16cRsiVal = input.float(30,  "RSI",                group="[ЛОНГ] Продажа: С DI+", inline="ls16c")
ls16cVfiOp  = input.string(">", "VFI", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16c")
ls16cVfiVal = input.float(5,   "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls16c")
ls16cDiOp   = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16c")
ls16cDiVal  = input.float(25,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls16c")

enableLS16d = input.bool(false, "LS16d: RSI+VFI+DI+", group="[ЛОНГ] Продажа: С DI+", inline="ls16d")
ls16dRsiOp  = input.string("<", "", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16d")
ls16dRsiVal = input.float(25,  "RSI",                group="[ЛОНГ] Продажа: С DI+", inline="ls16d")
ls16dVfiOp  = input.string(">", "VFI", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16d")
ls16dVfiVal = input.float(10,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls16d")
ls16dDiOp   = input.string(">", "DI+", options=["<",">"], group="[ЛОНГ] Продажа: С DI+", inline="ls16d")
ls16dDiVal  = input.float(30,  "",                   group="[ЛОНГ] Продажа: С DI+", inline="ls16d")

enableLSD1 = input.bool(false, "LSD1: RSI",         group="[ЛОНГ] Прямая продажа (без фильтров)", inline="lsd1")
lsd1RsiOp  = input.string(">", "", options=["<",">"], group="[ЛОНГ] Прямая продажа (без фильтров)", inline="lsd1")
lsd1RsiVal = input.float(70,  "RSI",                group="[ЛОНГ] Прямая продажа (без фильтров)", inline="lsd1")

enableLSD2 = input.bool(false, "LSD2: VFI",         group="[ЛОНГ] Прямая продажа (без фильтров)", inline="lsd2")
lsd2VfiOp  = input.string("<", "", options=["<",">"], group="[ЛОНГ] Прямая продажа (без фильтров)", inline="lsd2")
lsd2VfiVal = input.float(-5,  "VFI",                group="[ЛОНГ] Прямая продажа (без фильтров)", inline="lsd2")

enableLSD3 = input.bool(false, "LSD3: DI+",         group="[ЛОНГ] Прямая продажа (без фильтров)", inline="lsd3")
lsd3DiOp   = input.string("<", "", options=["<",">"], group="[ЛОНГ] Прямая продажа (без фильтров)", inline="lsd3")
lsd3DiVal  = input.float(20,  "DI+",                group="[ЛОНГ] Прямая продажа (без фильтров)", inline="lsd3")

lbbUseSale  = input.bool(false, "Блок если была продажа за N свечей",  group="[ЛОНГ] Фильтр блокировки покупки")
lbbSaleBars = input.int(10,     "Кол-во свечей назад для продажи",     group="[ЛОНГ] Фильтр блокировки покупки", minval=1)
lbbUseRsi   = input.bool(false, "Блок если RSI был экстремальным",     group="[ЛОНГ] Фильтр блокировки покупки", inline="lbbrsi")
lbbRsiOp    = input.string(">", "", options=["<",">"],                  group="[ЛОНГ] Фильтр блокировки покупки", inline="lbbrsi")
lbbRsiVal   = input.float(80,   "RSI за N свечей назад",               group="[ЛОНГ] Фильтр блокировки покупки", inline="lbbrsi")
lbbRsiBars  = input.int(10,     "",                                     group="[ЛОНГ] Фильтр блокировки покупки", inline="lbbrsi", minval=1)
lbbUseVfi   = input.bool(false, "Блок если VFI был экстремальным",     group="[ЛОНГ] Фильтр блокировки покупки", inline="lbbvfi")
lbbVfiOp    = input.string("<", "", options=["<",">"],                  group="[ЛОНГ] Фильтр блокировки покупки", inline="lbbvfi")
lbbVfiVal   = input.float(-20,  "VFI за N свечей назад",               group="[ЛОНГ] Фильтр блокировки покупки", inline="lbbvfi")
lbbVfiBars  = input.int(10,     "",                                     group="[ЛОНГ] Фильтр блокировки покупки", inline="lbbvfi", minval=1)

// ═══════════════════════════════════════════════════════════════════════════
// ШОРТ — НАСТРОЙКИ ВХОДА
// ═══════════════════════════════════════════════════════════════════════════

enableSB1  = input.bool(true,  "SB1: RSI+VFI", group="[ШОРТ] Вход: RSI+VFI", inline="sb1")
sb1RsiOp   = input.string(">", "",    options=["<",">"], group="[ШОРТ] Вход: RSI+VFI", inline="sb1")
sb1RsiVal  = input.float(70,  "RSI",                    group="[ШОРТ] Вход: RSI+VFI", inline="sb1")
sb1VfiOp   = input.string("<","VFI",  options=["<",">"], group="[ШОРТ] Вход: RSI+VFI", inline="sb1")
sb1VfiVal  = input.float(-10, "",                       group="[ШОРТ] Вход: RSI+VFI", inline="sb1")

enableSB2  = input.bool(true,  "SB2: RSI+VFI", group="[ШОРТ] Вход: RSI+VFI", inline="sb2")
sb2RsiOp   = input.string(">", "",    options=["<",">"], group="[ШОРТ] Вход: RSI+VFI", inline="sb2")
sb2RsiVal  = input.float(75,  "RSI",                    group="[ШОРТ] Вход: RSI+VFI", inline="sb2")
sb2VfiOp   = input.string("<","VFI",  options=["<",">"], group="[ШОРТ] Вход: RSI+VFI", inline="sb2")
sb2VfiVal  = input.float(-15, "",                       group="[ШОРТ] Вход: RSI+VFI", inline="sb2")

enableSB3  = input.bool(true,  "SB3: RSI+VFI", group="[ШОРТ] Вход: RSI+VFI", inline="sb3")
sb3RsiOp   = input.string(">", "",    options=["<",">"], group="[ШОРТ] Вход: RSI+VFI", inline="sb3")
sb3RsiVal  = input.float(65,  "RSI",                    group="[ШОРТ] Вход: RSI+VFI", inline="sb3")
sb3VfiOp   = input.string("<","VFI",  options=["<",">"], group="[ШОРТ] Вход: RSI+VFI", inline="sb3")
sb3VfiVal  = input.float(-5,  "",                       group="[ШОРТ] Вход: RSI+VFI", inline="sb3")

enableSB4  = input.bool(true,  "SB4: RSI+VFI", group="[ШОРТ] Вход: RSI+VFI", inline="sb4")
sb4RsiOp   = input.string("<", "",    options=["<",">"], group="[ШОРТ] Вход: RSI+VFI", inline="sb4")
sb4RsiVal  = input.float(40,  "RSI",                    group="[ШОРТ] Вход: RSI+VFI", inline="sb4")
sb4VfiOp   = input.string("<","VFI",  options=["<",">"], group="[ШОРТ] Вход: RSI+VFI", inline="sb4")
sb4VfiVal  = input.float(-10, "",                       group="[ШОРТ] Вход: RSI+VFI", inline="sb4")

enableSB5  = input.bool(true,  "SB5: RSI",  group="[ШОРТ] Вход: Только RSI", inline="sb5")
sb5RsiOp   = input.string(">", "",    options=["<",">"], group="[ШОРТ] Вход: Только RSI", inline="sb5")
sb5RsiVal  = input.float(70,  "RSI",                    group="[ШОРТ] Вход: Только RSI", inline="sb5")

enableSB6  = input.bool(true,  "SB6: RSI",  group="[ШОРТ] Вход: Только RSI", inline="sb6")
sb6RsiOp   = input.string(">", "",    options=["<",">"], group="[ШОРТ] Вход: Только RSI", inline="sb6")
sb6RsiVal  = input.float(75,  "RSI",                    group="[ШОРТ] Вход: Только RSI", inline="sb6")

enableSB7  = input.bool(true,  "SB7: RSI",  group="[ШОРТ] Вход: Только RSI", inline="sb7")
sb7RsiOp   = input.string(">", "",    options=["<",">"], group="[ШОРТ] Вход: Только RSI", inline="sb7")
sb7RsiVal  = input.float(80,  "RSI",                    group="[ШОРТ] Вход: Только RSI", inline="sb7")

enableSB8  = input.bool(true,  "SB8: RSI",  group="[ШОРТ] Вход: Только RSI", inline="sb8")
sb8RsiOp   = input.string("<", "",    options=["<",">"], group="[ШОРТ] Вход: Только RSI", inline="sb8")
sb8RsiVal  = input.float(40,  "RSI",                    group="[ШОРТ] Вход: Только RSI", inline="sb8")

enableSB9  = input.bool(true,  "SB9:  VFI", group="[ШОРТ] Вход: Только VFI", inline="sb9")
sb9VfiOp   = input.string("<", "",    options=["<",">"], group="[ШОРТ] Вход: Только VFI", inline="sb9")
sb9VfiVal  = input.float(-5,  "VFI",                    group="[ШОРТ] Вход: Только VFI", inline="sb9")

enableSB10 = input.bool(true,  "SB10: VFI", group="[ШОРТ] Вход: Только VFI", inline="sb10")
sb10VfiOp  = input.string("<", "",    options=["<",">"], group="[ШОРТ] Вход: Только VFI", inline="sb10")
sb10VfiVal = input.float(-10, "VFI",                    group="[ШОРТ] Вход: Только VFI", inline="sb10")

enableSB11 = input.bool(true,  "SB11: VFI", group="[ШОРТ] Вход: Только VFI", inline="sb11")
sb11VfiOp  = input.string(">", "",    options=["<",">"], group="[ШОРТ] Вход: Только VFI", inline="sb11")
sb11VfiVal = input.float(5,   "VFI",                    group="[ШОРТ] Вход: Только VFI", inline="sb11")

enableSB12 = input.bool(true,  "SB12: VFI", group="[ШОРТ] Вход: Только VFI", inline="sb12")
sb12VfiOp  = input.string(">", "",    options=["<",">"], group="[ШОРТ] Вход: Только VFI", inline="sb12")
sb12VfiVal = input.float(10,  "VFI",                    group="[ШОРТ] Вход: Только VFI", inline="sb12")

enableSB13  = input.bool(false, "SB13a: DI+",        group="[ШОРТ] Вход: С DI+", inline="sb13a")
sb13AdxOp   = input.string(">", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb13a")
sb13AdxVal  = input.float(25,  "DI+",                group="[ШОРТ] Вход: С DI+", inline="sb13a")

enableSB13b = input.bool(false, "SB13b: DI+",        group="[ШОРТ] Вход: С DI+", inline="sb13b")
sb13bAdxOp  = input.string("<", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb13b")
sb13bAdxVal = input.float(20,  "DI+",                group="[ШОРТ] Вход: С DI+", inline="sb13b")

enableSB14  = input.bool(false, "SB14a: RSI+DI+",    group="[ШОРТ] Вход: С DI+", inline="sb14a")
sb14RsiOp   = input.string(">", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb14a")
sb14RsiVal  = input.float(70,  "RSI",                group="[ШОРТ] Вход: С DI+", inline="sb14a")
sb14AdxOp   = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb14a")
sb14AdxVal  = input.float(25,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb14a")

enableSB14b = input.bool(false, "SB14b: RSI+DI+",    group="[ШОРТ] Вход: С DI+", inline="sb14b")
sb14bRsiOp  = input.string(">", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb14b")
sb14bRsiVal = input.float(75,  "RSI",                group="[ШОРТ] Вход: С DI+", inline="sb14b")
sb14bAdxOp  = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb14b")
sb14bAdxVal = input.float(30,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb14b")

enableSB14c = input.bool(false, "SB14c: RSI+DI+",    group="[ШОРТ] Вход: С DI+", inline="sb14c")
sb14cRsiOp  = input.string("<", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb14c")
sb14cRsiVal = input.float(40,  "RSI",                group="[ШОРТ] Вход: С DI+", inline="sb14c")
sb14cAdxOp  = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb14c")
sb14cAdxVal = input.float(20,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb14c")

enableSB14d = input.bool(false, "SB14d: RSI+DI+",    group="[ШОРТ] Вход: С DI+", inline="sb14d")
sb14dRsiOp  = input.string("<", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb14d")
sb14dRsiVal = input.float(35,  "RSI",                group="[ШОРТ] Вход: С DI+", inline="sb14d")
sb14dAdxOp  = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb14d")
sb14dAdxVal = input.float(25,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb14d")

enableSB15  = input.bool(false, "SB15a: VFI+DI+",   group="[ШОРТ] Вход: С DI+", inline="sb15a")
sb15VfiOp   = input.string("<", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb15a")
sb15VfiVal  = input.float(-5,  "VFI",                group="[ШОРТ] Вход: С DI+", inline="sb15a")
sb15AdxOp   = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb15a")
sb15AdxVal  = input.float(25,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb15a")

enableSB15b = input.bool(false, "SB15b: VFI+DI+",   group="[ШОРТ] Вход: С DI+", inline="sb15b")
sb15bVfiOp  = input.string("<", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb15b")
sb15bVfiVal = input.float(-10, "VFI",                group="[ШОРТ] Вход: С DI+", inline="sb15b")
sb15bAdxOp  = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb15b")
sb15bAdxVal = input.float(30,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb15b")

enableSB15c = input.bool(false, "SB15c: VFI+DI+",   group="[ШОРТ] Вход: С DI+", inline="sb15c")
sb15cVfiOp  = input.string(">", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb15c")
sb15cVfiVal = input.float(5,   "VFI",                group="[ШОРТ] Вход: С DI+", inline="sb15c")
sb15cAdxOp  = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb15c")
sb15cAdxVal = input.float(20,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb15c")

enableSB15d = input.bool(false, "SB15d: VFI+DI+",   group="[ШОРТ] Вход: С DI+", inline="sb15d")
sb15dVfiOp  = input.string(">", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb15d")
sb15dVfiVal = input.float(10,  "VFI",                group="[ШОРТ] Вход: С DI+", inline="sb15d")
sb15dAdxOp  = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb15d")
sb15dAdxVal = input.float(25,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb15d")

enableSB16  = input.bool(false, "SB16a: RSI+VFI+DI+", group="[ШОРТ] Вход: С DI+", inline="sb16a")
sb16RsiOp   = input.string(">", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16a")
sb16RsiVal  = input.float(70,  "RSI",                group="[ШОРТ] Вход: С DI+", inline="sb16a")
sb16VfiOp   = input.string("<", "VFI", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16a")
sb16VfiVal  = input.float(-5,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb16a")
sb16AdxOp   = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16a")
sb16AdxVal  = input.float(25,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb16a")

enableSB16b = input.bool(false, "SB16b: RSI+VFI+DI+", group="[ШОРТ] Вход: С DI+", inline="sb16b")
sb16bRsiOp  = input.string(">", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16b")
sb16bRsiVal = input.float(75,  "RSI",                group="[ШОРТ] Вход: С DI+", inline="sb16b")
sb16bVfiOp  = input.string("<", "VFI", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16b")
sb16bVfiVal = input.float(-10, "",                   group="[ШОРТ] Вход: С DI+", inline="sb16b")
sb16bAdxOp  = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16b")
sb16bAdxVal = input.float(30,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb16b")

enableSB16c = input.bool(false, "SB16c: RSI+VFI+DI+", group="[ШОРТ] Вход: С DI+", inline="sb16c")
sb16cRsiOp  = input.string("<", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16c")
sb16cRsiVal = input.float(40,  "RSI",                group="[ШОРТ] Вход: С DI+", inline="sb16c")
sb16cVfiOp  = input.string(">", "VFI", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16c")
sb16cVfiVal = input.float(5,   "",                   group="[ШОРТ] Вход: С DI+", inline="sb16c")
sb16cAdxOp  = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16c")
sb16cAdxVal = input.float(20,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb16c")

enableSB16d = input.bool(false, "SB16d: RSI+VFI+DI+", group="[ШОРТ] Вход: С DI+", inline="sb16d")
sb16dRsiOp  = input.string("<", "", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16d")
sb16dRsiVal = input.float(35,  "RSI",                group="[ШОРТ] Вход: С DI+", inline="sb16d")
sb16dVfiOp  = input.string(">", "VFI", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16d")
sb16dVfiVal = input.float(10,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb16d")
sb16dAdxOp  = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Вход: С DI+", inline="sb16d")
sb16dAdxVal = input.float(25,  "",                   group="[ШОРТ] Вход: С DI+", inline="sb16d")

// ═══════════════════════════════════════════════════════════════════════════
// ШОРТ — НАСТРОЙКИ ЗАКРЫТИЯ
// ═══════════════════════════════════════════════════════════════════════════

enableSS1  = input.bool(true,  "SS1: RSI+VFI", group="[ШОРТ] Закрытие: RSI+VFI", inline="ss1")
ss1RsiOp   = input.string("<", "",    options=["<",">"], group="[ШОРТ] Закрытие: RSI+VFI", inline="ss1")
ss1RsiVal  = input.float(30,  "RSI",                    group="[ШОРТ] Закрытие: RSI+VFI", inline="ss1")
ss1VfiOp   = input.string(">","VFI",  options=["<",">"], group="[ШОРТ] Закрытие: RSI+VFI", inline="ss1")
ss1VfiVal  = input.float(5,   "",                       group="[ШОРТ] Закрытие: RSI+VFI", inline="ss1")

enableSS2  = input.bool(true,  "SS2: RSI+VFI", group="[ШОРТ] Закрытие: RSI+VFI", inline="ss2")
ss2RsiOp   = input.string("<", "",    options=["<",">"], group="[ШОРТ] Закрытие: RSI+VFI", inline="ss2")
ss2RsiVal  = input.float(25,  "RSI",                    group="[ШОРТ] Закрытие: RSI+VFI", inline="ss2")
ss2VfiOp   = input.string(">","VFI",  options=["<",">"], group="[ШОРТ] Закрытие: RSI+VFI", inline="ss2")
ss2VfiVal  = input.float(10,  "",                       group="[ШОРТ] Закрытие: RSI+VFI", inline="ss2")

enableSS3  = input.bool(true,  "SS3: RSI+VFI", group="[ШОРТ] Закрытие: RSI+VFI", inline="ss3")
ss3RsiOp   = input.string(">", "",    options=["<",">"], group="[ШОРТ] Закрытие: RSI+VFI", inline="ss3")
ss3RsiVal  = input.float(70,  "RSI",                    group="[ШОРТ] Закрытие: RSI+VFI", inline="ss3")
ss3VfiOp   = input.string("<","VFI",  options=["<",">"], group="[ШОРТ] Закрытие: RSI+VFI", inline="ss3")
ss3VfiVal  = input.float(-10, "",                       group="[ШОРТ] Закрытие: RSI+VFI", inline="ss3")

enableSS4  = input.bool(true,  "SS4: RSI+VFI", group="[ШОРТ] Закрытие: RSI+VFI", inline="ss4")
ss4RsiOp   = input.string("<", "",    options=["<",">"], group="[ШОРТ] Закрытие: RSI+VFI", inline="ss4")
ss4RsiVal  = input.float(35,  "RSI",                    group="[ШОРТ] Закрытие: RSI+VFI", inline="ss4")
ss4VfiOp   = input.string(">","VFI",  options=["<",">"], group="[ШОРТ] Закрытие: RSI+VFI", inline="ss4")
ss4VfiVal  = input.float(0,   "",                       group="[ШОРТ] Закрытие: RSI+VFI", inline="ss4")

enableSS5  = input.bool(true,  "SS5: RSI",  group="[ШОРТ] Закрытие: Только RSI", inline="ss5")
ss5RsiOp   = input.string("<", "",    options=["<",">"], group="[ШОРТ] Закрытие: Только RSI", inline="ss5")
ss5RsiVal  = input.float(30,  "RSI",                    group="[ШОРТ] Закрытие: Только RSI", inline="ss5")

enableSS6  = input.bool(true,  "SS6: RSI",  group="[ШОРТ] Закрытие: Только RSI", inline="ss6")
ss6RsiOp   = input.string("<", "",    options=["<",">"], group="[ШОРТ] Закрытие: Только RSI", inline="ss6")
ss6RsiVal  = input.float(20,  "RSI",                    group="[ШОРТ] Закрытие: Только RSI", inline="ss6")

enableSS7  = input.bool(true,  "SS7: RSI",  group="[ШОРТ] Закрытие: Только RSI", inline="ss7")
ss7RsiOp   = input.string(">", "",    options=["<",">"], group="[ШОРТ] Закрытие: Только RSI", inline="ss7")
ss7RsiVal  = input.float(70,  "RSI",                    group="[ШОРТ] Закрытие: Только RSI", inline="ss7")

enableSS8  = input.bool(true,  "SS8: RSI",  group="[ШОРТ] Закрытие: Только RSI", inline="ss8")
ss8RsiOp   = input.string(">", "",    options=["<",">"], group="[ШОРТ] Закрытие: Только RSI", inline="ss8")
ss8RsiVal  = input.float(75,  "RSI",                    group="[ШОРТ] Закрытие: Только RSI", inline="ss8")

enableSS9  = input.bool(true,  "SS9:  VFI", group="[ШОРТ] Закрытие: Только VFI", inline="ss9")
ss9VfiOp   = input.string(">", "",    options=["<",">"], group="[ШОРТ] Закрытие: Только VFI", inline="ss9")
ss9VfiVal  = input.float(5,   "VFI",                    group="[ШОРТ] Закрытие: Только VFI", inline="ss9")

enableSS10 = input.bool(true,  "SS10: VFI", group="[ШОРТ] Закрытие: Только VFI", inline="ss10")
ss10VfiOp  = input.string(">", "",    options=["<",">"], group="[ШОРТ] Закрытие: Только VFI", inline="ss10")
ss10VfiVal = input.float(10,  "VFI",                    group="[ШОРТ] Закрытие: Только VFI", inline="ss10")

enableSS11 = input.bool(true,  "SS11: VFI", group="[ШОРТ] Закрытие: Только VFI", inline="ss11")
ss11VfiOp  = input.string("<", "",    options=["<",">"], group="[ШОРТ] Закрытие: Только VFI", inline="ss11")
ss11VfiVal = input.float(-5,  "VFI",                    group="[ШОРТ] Закрытие: Только VFI", inline="ss11")

enableSS12 = input.bool(true,  "SS12: VFI", group="[ШОРТ] Закрытие: Только VFI", inline="ss12")
ss12VfiOp  = input.string("<", "",    options=["<",">"], group="[ШОРТ] Закрытие: Только VFI", inline="ss12")
ss12VfiVal = input.float(-10, "VFI",                    group="[ШОРТ] Закрытие: Только VFI", inline="ss12")

enableSS13  = input.bool(false, "SS13a: DI+",        group="[ШОРТ] Закрытие: С DI+", inline="ss13a")
ss13DiOp    = input.string(">", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss13a")
ss13DiVal   = input.float(25,  "DI+",                group="[ШОРТ] Закрытие: С DI+", inline="ss13a")

enableSS13b = input.bool(false, "SS13b: DI+",        group="[ШОРТ] Закрытие: С DI+", inline="ss13b")
ss13bDiOp   = input.string("<", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss13b")
ss13bDiVal  = input.float(20,  "DI+",                group="[ШОРТ] Закрытие: С DI+", inline="ss13b")

enableSS14  = input.bool(false, "SS14a: RSI+DI+",    group="[ШОРТ] Закрытие: С DI+", inline="ss14a")
ss14RsiOp   = input.string("<", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss14a")
ss14RsiVal  = input.float(30,  "RSI",                group="[ШОРТ] Закрытие: С DI+", inline="ss14a")
ss14DiOp    = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss14a")
ss14DiVal   = input.float(25,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss14a")

enableSS14b = input.bool(false, "SS14b: RSI+DI+",    group="[ШОРТ] Закрытие: С DI+", inline="ss14b")
ss14bRsiOp  = input.string("<", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss14b")
ss14bRsiVal = input.float(25,  "RSI",                group="[ШОРТ] Закрытие: С DI+", inline="ss14b")
ss14bDiOp   = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss14b")
ss14bDiVal  = input.float(30,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss14b")

enableSS14c = input.bool(false, "SS14c: RSI+DI+",    group="[ШОРТ] Закрытие: С DI+", inline="ss14c")
ss14cRsiOp  = input.string(">", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss14c")
ss14cRsiVal = input.float(70,  "RSI",                group="[ШОРТ] Закрытие: С DI+", inline="ss14c")
ss14cDiOp   = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss14c")
ss14cDiVal  = input.float(20,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss14c")

enableSS14d = input.bool(false, "SS14d: RSI+DI+",    group="[ШОРТ] Закрытие: С DI+", inline="ss14d")
ss14dRsiOp  = input.string(">", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss14d")
ss14dRsiVal = input.float(65,  "RSI",                group="[ШОРТ] Закрытие: С DI+", inline="ss14d")
ss14dDiOp   = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss14d")
ss14dDiVal  = input.float(25,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss14d")

enableSS15  = input.bool(false, "SS15a: VFI+DI+",   group="[ШОРТ] Закрытие: С DI+", inline="ss15a")
ss15VfiOp   = input.string(">", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss15a")
ss15VfiVal  = input.float(5,   "VFI",                group="[ШОРТ] Закрытие: С DI+", inline="ss15a")
ss15DiOp    = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss15a")
ss15DiVal   = input.float(25,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss15a")

enableSS15b = input.bool(false, "SS15b: VFI+DI+",   group="[ШОРТ] Закрытие: С DI+", inline="ss15b")
ss15bVfiOp  = input.string(">", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss15b")
ss15bVfiVal = input.float(10,  "VFI",                group="[ШОРТ] Закрытие: С DI+", inline="ss15b")
ss15bDiOp   = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss15b")
ss15bDiVal  = input.float(30,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss15b")

enableSS15c = input.bool(false, "SS15c: VFI+DI+",   group="[ШОРТ] Закрытие: С DI+", inline="ss15c")
ss15cVfiOp  = input.string("<", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss15c")
ss15cVfiVal = input.float(-5,  "VFI",                group="[ШОРТ] Закрытие: С DI+", inline="ss15c")
ss15cDiOp   = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss15c")
ss15cDiVal  = input.float(20,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss15c")

enableSS15d = input.bool(false, "SS15d: VFI+DI+",   group="[ШОРТ] Закрытие: С DI+", inline="ss15d")
ss15dVfiOp  = input.string("<", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss15d")
ss15dVfiVal = input.float(-10, "VFI",                group="[ШОРТ] Закрытие: С DI+", inline="ss15d")
ss15dDiOp   = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss15d")
ss15dDiVal  = input.float(25,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss15d")

enableSS16  = input.bool(false, "SS16a: RSI+VFI+DI+", group="[ШОРТ] Закрытие: С DI+", inline="ss16a")
ss16RsiOp   = input.string("<", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16a")
ss16RsiVal  = input.float(30,  "RSI",                group="[ШОРТ] Закрытие: С DI+", inline="ss16a")
ss16VfiOp   = input.string(">", "VFI", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16a")
ss16VfiVal  = input.float(5,   "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss16a")
ss16DiOp    = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16a")
ss16DiVal   = input.float(25,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss16a")

enableSS16b = input.bool(false, "SS16b: RSI+VFI+DI+", group="[ШОРТ] Закрытие: С DI+", inline="ss16b")
ss16bRsiOp  = input.string("<", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16b")
ss16bRsiVal = input.float(25,  "RSI",                group="[ШОРТ] Закрытие: С DI+", inline="ss16b")
ss16bVfiOp  = input.string(">", "VFI", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16b")
ss16bVfiVal = input.float(10,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss16b")
ss16bDiOp   = input.string(">", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16b")
ss16bDiVal  = input.float(30,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss16b")

enableSS16c = input.bool(false, "SS16c: RSI+VFI+DI+", group="[ШОРТ] Закрытие: С DI+", inline="ss16c")
ss16cRsiOp  = input.string(">", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16c")
ss16cRsiVal = input.float(70,  "RSI",                group="[ШОРТ] Закрытие: С DI+", inline="ss16c")
ss16cVfiOp  = input.string("<", "VFI", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16c")
ss16cVfiVal = input.float(-5,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss16c")
ss16cDiOp   = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16c")
ss16cDiVal  = input.float(20,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss16c")

enableSS16d = input.bool(false, "SS16d: RSI+VFI+DI+", group="[ШОРТ] Закрытие: С DI+", inline="ss16d")
ss16dRsiOp  = input.string(">", "", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16d")
ss16dRsiVal = input.float(65,  "RSI",                group="[ШОРТ] Закрытие: С DI+", inline="ss16d")
ss16dVfiOp  = input.string("<", "VFI", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16d")
ss16dVfiVal = input.float(-10, "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss16d")
ss16dDiOp   = input.string("<", "DI+", options=["<",">"], group="[ШОРТ] Закрытие: С DI+", inline="ss16d")
ss16dDiVal  = input.float(25,  "",                   group="[ШОРТ] Закрытие: С DI+", inline="ss16d")

enableSSD1 = input.bool(false, "SSD1: RSI",         group="[ШОРТ] Прямое закрытие (без фильтров)", inline="ssd1")
ssd1RsiOp  = input.string("<", "", options=["<",">"], group="[ШОРТ] Прямое закрытие (без фильтров)", inline="ssd1")
ssd1RsiVal = input.float(30,  "RSI",                group="[ШОРТ] Прямое закрытие (без фильтров)", inline="ssd1")

enableSSD2 = input.bool(false, "SSD2: VFI",         group="[ШОРТ] Прямое закрытие (без фильтров)", inline="ssd2")
ssd2VfiOp  = input.string(">", "", options=["<",">"], group="[ШОРТ] Прямое закрытие (без фильтров)", inline="ssd2")
ssd2VfiVal = input.float(5,   "VFI",                group="[ШОРТ] Прямое закрытие (без фильтров)", inline="ssd2")

enableSSD3 = input.bool(false, "SSD3: DI+",         group="[ШОРТ] Прямое закрытие (без фильтров)", inline="ssd3")
ssd3DiOp   = input.string(">", "", options=["<",">"], group="[ШОРТ] Прямое закрытие (без фильтров)", inline="ssd3")
ssd3DiVal  = input.float(25,  "DI+",                group="[ШОРТ] Прямое закрытие (без фильтров)", inline="ssd3")

sbbUseSale  = input.bool(false, "Блок если была покупка за N свечей", group="[ШОРТ] Фильтр блокировки входа")
sbbSaleBars = input.int(10,     "Кол-во свечей назад",               group="[ШОРТ] Фильтр блокировки входа", minval=1)
sbbUseRsi   = input.bool(false, "Блок если RSI был экстремальным",   group="[ШОРТ] Фильтр блокировки входа", inline="sbbrsi")
sbbRsiOp    = input.string("<", "", options=["<",">"],                group="[ШОРТ] Фильтр блокировки входа", inline="sbbrsi")
sbbRsiVal   = input.float(20,   "RSI за N свечей назад",             group="[ШОРТ] Фильтр блокировки входа", inline="sbbrsi")
sbbRsiBars  = input.int(10,     "",                                   group="[ШОРТ] Фильтр блокировки входа", inline="sbbrsi", minval=1)
sbbUseVfi   = input.bool(false, "Блок если VFI был экстремальным",   group="[ШОРТ] Фильтр блокировки входа", inline="sbbvfi")
sbbVfiOp    = input.string(">", "", options=["<",">"],                group="[ШОРТ] Фильтр блокировки входа", inline="sbbvfi")
sbbVfiVal   = input.float(20,   "VFI за N свечей назад",             group="[ШОРТ] Фильтр блокировки входа", inline="sbbvfi")
sbbVfiBars  = input.int(10,     "",                                   group="[ШОРТ] Фильтр блокировки входа", inline="sbbvfi", minval=1)

// ═══════════════════════════════════════════════════════════════════════════
// РАСЧЁТ ИНДИКАТОРОВ
// ═══════════════════════════════════════════════════════════════════════════

rsi     = ta.rsi(close, rsiPeriod)
typical = hlc3
inter   = math.log(typical) - math.log(typical[1])
vinter  = ta.stdev(inter, 30)
cutoff  = vfiCoef * vinter * close
vave    = ta.sma(volume, vfiLength)[1]
vmax    = vave * vfiVcoef
vc      = volume < vmax ? volume : vmax
mf      = typical - typical[1]
vcp     = mf > cutoff ? vc : mf < -cutoff ? -vc : 0
vfi     = ta.sma(math.sum(vcp, vfiLength) / vave, 3)

adxTR      = math.max(math.max(high - low, math.abs(high - close[1])), math.abs(low - close[1]))
adxDMPos   = high - high[1] > low[1] - low ? math.max(high - high[1], 0.0) : 0.0
adxDMMinus = low[1] - low > high - high[1] ? math.max(low[1] - low, 0.0)   : 0.0
var float smTR  = 0.0
var float smPos = 0.0
var float smNeg = 0.0
smTR  := nz(smTR[1])  - nz(smTR[1])  / adxLen + adxTR
smPos := nz(smPos[1]) - nz(smPos[1]) / adxLen + adxDMPos
smNeg := nz(smNeg[1]) - nz(smNeg[1]) / adxLen + adxDMMinus
diPos = smTR != 0 ? smPos / smTR * 100 : 0.0
diNeg = smTR != 0 ? smNeg / smTR * 100 : 0.0
dx    = (diPos + diNeg) != 0 ? math.abs(diPos - diNeg) / (diPos + diNeg) * 100 : 0.0
adx   = ta.sma(dx, adxLen)

// Fixed pivot detection parameters
pivotBars = 2

// Calculate pivots with fixed bars
ph = ta.pivothigh(pivotBars, pivotBars)
pl = ta.pivotlow(pivotBars, pivotBars)

// Track pivot history with types
var array<int>    phBarIndices   = array.new_int()
var array<float>  phValues       = array.new_float()
var array<string> phTypes        = array.new_string()

var array<int>    plBarIndices   = array.new_int()
var array<float>  plValues       = array.new_float()
var array<string> plTypes        = array.new_string()

// When a new pivot high is detected
if not na(ph)
    pivotType = "LH"  // Default to Lower High
    // Compare with previous pivot high if exists
    if array.size(phValues) > 0
        prevPhValue = array.get(phValues, array.size(phValues) - 1)
        pivotType := ph > prevPhValue ? "HH" : "LH"
    else
        pivotType := "HH"  // First pivot high is considered HH
    
    array.push(phBarIndices, bar_index - pivotBars)
    array.push(phValues, ph)
    array.push(phTypes, pivotType)
    
    // Keep only recent pivots (last 500 to limit memory)
    if array.size(phBarIndices) > 500
        array.shift(phBarIndices)
        array.shift(phValues)
        array.shift(phTypes)

// When a new pivot low is detected
if not na(pl)
    pivotType = "LL"  // Default to Lower Low
    // Compare with previous pivot low if exists
    if array.size(plValues) > 0
        prevPlValue = array.get(plValues, array.size(plValues) - 1)
        pivotType := pl > prevPlValue ? "HL" : "LL"
    else
        pivotType := "LL"  // First pivot low is considered LL
    
    array.push(plBarIndices, bar_index - pivotBars)
    array.push(plValues, pl)
    array.push(plTypes, pivotType)
    
    // Keep only recent pivots (last 500 to limit memory)
    if array.size(plBarIndices) > 500
        array.shift(plBarIndices)
        array.shift(plValues)
        array.shift(plTypes)

// ═══════════════════════════════════════════════════════════════════════════
// ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
// ═══════════════════════════════════════════════════════════════════════════

compare(val, op, thresh) =>
    op == "<" ? val < thresh : val > thresh

checkRange(startBar, endBar, indicator, op, thresh) =>
    result = false
    if bar_index >= endBar
        for i = startBar to endBar
            if compare(indicator[i], op, thresh)
                result := true
                break
    result

// ═══════════════════════════════════════════════════════════════════════════
// УНИВЕРСАЛЬНЫЙ ДЕТЕКТОР ПИВОТ-ПАТТЕРНОВ (поддерживает все 16 комбинаций)
// ═══════════════════════════════════════════════════════════════════════════

// Детектор паттернов - ищет последовательность firstType → secondType в окне
pivotPatternDetector(firstType, secondType, windowBack, windowFwd, signalBar) =>
    string explanation = "No pattern"
    bool found = false
    
    // Determine which pivot arrays to use based on type
    useHighFirst  = (firstType == "HH" or firstType == "LH")
    useHighSecond = (secondType == "HH" or secondType == "LH")
    
    // Define search window
    startBar = signalBar - windowBack
    endBar   = signalBar + windowFwd
    
    // Search for pattern
    firstFoundBar = -1
    secondFoundBar = -1
    
    // Search in high pivots if needed
    if useHighFirst and array.size(phBarIndices) > 0
        for i = 0 to array.size(phBarIndices) - 1
            pivotBar = array.get(phBarIndices, i)
            if pivotBar >= startBar and pivotBar <= endBar
                if array.get(phTypes, i) == firstType
                    firstFoundBar := pivotBar
                    break
    
    // Search in low pivots if needed
    if not useHighFirst and array.size(plBarIndices) > 0
        for i = 0 to array.size(plBarIndices) - 1
            pivotBar = array.get(plBarIndices, i)
            if pivotBar >= startBar and pivotBar <= endBar
                if array.get(plTypes, i) == firstType
                    firstFoundBar := pivotBar
                    break
    
    // If first type found, search for second type after it
    if firstFoundBar >= 0
        if useHighSecond and array.size(phBarIndices) > 0
            for i = 0 to array.size(phBarIndices) - 1
                pivotBar = array.get(phBarIndices, i)
                if pivotBar > firstFoundBar and pivotBar <= endBar
                    if array.get(phTypes, i) == secondType
                        secondFoundBar := pivotBar
                        found := true
                        explanation := firstType + "→" + secondType + " found"
                        break
        
        if not useHighSecond and array.size(plBarIndices) > 0
            for i = 0 to array.size(plBarIndices) - 1
                pivotBar = array.get(plBarIndices, i)
                if pivotBar > firstFoundBar and pivotBar <= endBar
                    if array.get(plTypes, i) == secondType
                        secondFoundBar := pivotBar
                        found := true
                        explanation := firstType + "→" + secondType + " found"
                        break
    
    [found, explanation]

// ═══════════════════════════════════════════════════════════════════════════
// СВЕЧНОЙ ПАТТЕРН
// ═══════════════════════════════════════════════════════════════════════════

isRed   = close < open
isGreen = close >= open

var int redCount   = 0
var int greenCount = 0

if isRed
    redCount   := redCount + 1
    greenCount := 0
else
    greenCount := greenCount + 1
    redCount   := 0

isFirstGreenAfterRed = not isRed and redCount[1] >= minRedCandles
isFirstRedAfterGreen = isRed and greenCount[1] >= minRedCandles

// ═══════════════════════════════════════════════════════════════════════════
// ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ДЛЯ ОТСЛЕЖИВАНИЯ
// ═══════════════════════════════════════════════════════════════════════════

var string pivotDetectorResult = ""
var int    barsInPosition      = 0

// Подсчёт баров в позиции
if strategy.position_size != 0
    barsInPosition := barsInPosition + 1
else
    barsInPosition := 0

// ═══════════════════════════════════════════════════════════════════════════
// ЛОГИКА ЛОНГА
// ═══════════════════════════════════════════════════════════════════════════

var string lBuyReason  = ""
lBuySignal = false

if enableLong and isFirstGreenAfterRed and strategy.position_size == 0
    rangeLen = redCount[1] + 1
    anyMet   = false

    if not anyMet and enableLB1
        if checkRange(0, rangeLen-1, rsi, lb1RsiOp, lb1RsiVal) and checkRange(0, rangeLen-1, vfi, lb1VfiOp, lb1VfiVal)
            anyMet := true
            lBuyReason := "LB1: RSI" + lb1RsiOp + str.tostring(lb1RsiVal) + " VFI" + lb1VfiOp + str.tostring(lb1VfiVal)
    if not anyMet and enableLB2
        if checkRange(0, rangeLen-1, rsi, lb2RsiOp, lb2RsiVal) and checkRange(0, rangeLen-1, vfi, lb2VfiOp, lb2VfiVal)
            anyMet := true
            lBuyReason := "LB2: RSI" + lb2RsiOp + str.tostring(lb2RsiVal) + " VFI" + lb2VfiOp + str.tostring(lb2VfiVal)
    if not anyMet and enableLB3
        if checkRange(0, rangeLen-1, rsi, lb3RsiOp, lb3RsiVal) and checkRange(0, rangeLen-1, vfi, lb3VfiOp, lb3VfiVal)
            anyMet := true
            lBuyReason := "LB3: RSI" + lb3RsiOp + str.tostring(lb3RsiVal) + " VFI" + lb3VfiOp + str.tostring(lb3VfiVal)
    if not anyMet and enableLB4
        if checkRange(0, rangeLen-1, rsi, lb4RsiOp, lb4RsiVal) and checkRange(0, rangeLen-1, vfi, lb4VfiOp, lb4VfiVal)
            anyMet := true
            lBuyReason := "LB4: RSI" + lb4RsiOp + str.tostring(lb4RsiVal) + " VFI" + lb4VfiOp + str.tostring(lb4VfiVal)
    if not anyMet and enableLB5
        if checkRange(0, rangeLen-1, rsi, lb5RsiOp, lb5RsiVal)
            anyMet := true
            lBuyReason := "LB5: RSI" + lb5RsiOp + str.tostring(lb5RsiVal)
    if not anyMet and enableLB6
        if checkRange(0, rangeLen-1, rsi, lb6RsiOp, lb6RsiVal)
            anyMet := true
            lBuyReason := "LB6: RSI" + lb6RsiOp + str.tostring(lb6RsiVal)
    if not anyMet and enableLB7
        if checkRange(0, rangeLen-1, rsi, lb7RsiOp, lb7RsiVal)
            anyMet := true
            lBuyReason := "LB7: RSI" + lb7RsiOp + str.tostring(lb7RsiVal)
    if not anyMet and enableLB8
        if checkRange(0, rangeLen-1, rsi, lb8RsiOp, lb8RsiVal)
            anyMet := true
            lBuyReason := "LB8: RSI" + lb8RsiOp + str.tostring(lb8RsiVal)
    if not anyMet and enableLB9
        if checkRange(0, rangeLen-1, vfi, lb9VfiOp, lb9VfiVal)
            anyMet := true
            lBuyReason := "LB9: VFI" + lb9VfiOp + str.tostring(lb9VfiVal)
    if not anyMet and enableLB10
        if checkRange(0, rangeLen-1, vfi, lb10VfiOp, lb10VfiVal)
            anyMet := true
            lBuyReason := "LB10: VFI" + lb10VfiOp + str.tostring(lb10VfiVal)
    if not anyMet and enableLB11
        if checkRange(0, rangeLen-1, vfi, lb11VfiOp, lb11VfiVal)
            anyMet := true
            lBuyReason := "LB11: VFI" + lb11VfiOp + str.tostring(lb11VfiVal)
    if not anyMet and enableLB12
        if checkRange(0, rangeLen-1, vfi, lb12VfiOp, lb12VfiVal)
            anyMet := true
            lBuyReason := "LB12: VFI" + lb12VfiOp + str.tostring(lb12VfiVal)
    if not anyMet and enableLB13
        if checkRange(0, rangeLen-1, diPos, lb13AdxOp, lb13AdxVal)
            anyMet := true
            lBuyReason := "LB13a: DI+" + lb13AdxOp + str.tostring(lb13AdxVal)
    if not anyMet and enableLB13b
        if checkRange(0, rangeLen-1, diPos, lb13bAdxOp, lb13bAdxVal)
            anyMet := true
            lBuyReason := "LB13b: DI+" + lb13bAdxOp + str.tostring(lb13bAdxVal)
    if not anyMet and enableLB14
        if checkRange(0, rangeLen-1, rsi, lb14RsiOp, lb14RsiVal) and checkRange(0, rangeLen-1, diPos, lb14AdxOp, lb14AdxVal)
            anyMet := true
            lBuyReason := "LB14a: RSI" + lb14RsiOp + str.tostring(lb14RsiVal) + " DI+" + lb14AdxOp + str.tostring(lb14AdxVal)
    if not anyMet and enableLB14b
        if checkRange(0, rangeLen-1, rsi, lb14bRsiOp, lb14bRsiVal) and checkRange(0, rangeLen-1, diPos, lb14bAdxOp, lb14bAdxVal)
            anyMet := true
            lBuyReason := "LB14b: RSI" + lb14bRsiOp + str.tostring(lb14bRsiVal) + " DI+" + lb14bAdxOp + str.tostring(lb14bAdxVal)
    if not anyMet and enableLB14c
        if checkRange(0, rangeLen-1, rsi, lb14cRsiOp, lb14cRsiVal) and checkRange(0, rangeLen-1, diPos, lb14cAdxOp, lb14cAdxVal)
            anyMet := true
            lBuyReason := "LB14c: RSI" + lb14cRsiOp + str.tostring(lb14cRsiVal) + " DI+" + lb14cAdxOp + str.tostring(lb14cAdxVal)
    if not anyMet and enableLB14d
        if checkRange(0, rangeLen-1, rsi, lb14dRsiOp, lb14dRsiVal) and checkRange(0, rangeLen-1, diPos, lb14dAdxOp, lb14dAdxVal)
            anyMet := true
            lBuyReason := "LB14d: RSI" + lb14dRsiOp + str.tostring(lb14dRsiVal) + " DI+" + lb14dAdxOp + str.tostring(lb14dAdxVal)
    if not anyMet and enableLB15
        if checkRange(0, rangeLen-1, vfi, lb15VfiOp, lb15VfiVal) and checkRange(0, rangeLen-1, diPos, lb15AdxOp, lb15AdxVal)
            anyMet := true
            lBuyReason := "LB15a: VFI" + lb15VfiOp + str.tostring(lb15VfiVal) + " DI+" + lb15AdxOp + str.tostring(lb15AdxVal)
    if not anyMet and enableLB15b
        if checkRange(0, rangeLen-1, vfi, lb15bVfiOp, lb15bVfiVal) and checkRange(0, rangeLen-1, diPos, lb15bAdxOp, lb15bAdxVal)
            anyMet := true
            lBuyReason := "LB15b: VFI" + lb15bVfiOp + str.tostring(lb15bVfiVal) + " DI+" + lb15bAdxOp + str.tostring(lb15bAdxVal)
    if not anyMet and enableLB15c
        if checkRange(0, rangeLen-1, vfi, lb15cVfiOp, lb15cVfiVal) and checkRange(0, rangeLen-1, diPos, lb15cAdxOp, lb15cAdxVal)
            anyMet := true
            lBuyReason := "LB15c: VFI" + lb15cVfiOp + str.tostring(lb15cVfiVal) + " DI+" + lb15cAdxOp + str.tostring(lb15cAdxVal)
    if not anyMet and enableLB15d
        if checkRange(0, rangeLen-1, vfi, lb15dVfiOp, lb15dVfiVal) and checkRange(0, rangeLen-1, diPos, lb15dAdxOp, lb15dAdxVal)
            anyMet := true
            lBuyReason := "LB15d: VFI" + lb15dVfiOp + str.tostring(lb15dVfiVal) + " DI+" + lb15dAdxOp + str.tostring(lb15dAdxVal)
    if not anyMet and enableLB16
        if checkRange(0, rangeLen-1, rsi, lb16RsiOp, lb16RsiVal) and checkRange(0, rangeLen-1, vfi, lb16VfiOp, lb16VfiVal) and checkRange(0, rangeLen-1, diPos, lb16AdxOp, lb16AdxVal)
            anyMet := true
            lBuyReason := "LB16a: RSI" + lb16RsiOp + str.tostring(lb16RsiVal) + " VFI" + lb16VfiOp + str.tostring(lb16VfiVal) + " DI+" + lb16AdxOp + str.tostring(lb16AdxVal)
    if not anyMet and enableLB16b
        if checkRange(0, rangeLen-1, rsi, lb16bRsiOp, lb16bRsiVal) and checkRange(0, rangeLen-1, vfi, lb16bVfiOp, lb16bVfiVal) and checkRange(0, rangeLen-1, diPos, lb16bAdxOp, lb16bAdxVal)
            anyMet := true
            lBuyReason := "LB16b: RSI" + lb16bRsiOp + str.tostring(lb16bRsiVal) + " VFI" + lb16bVfiOp + str.tostring(lb16bVfiVal) + " DI+" + lb16bAdxOp + str.tostring(lb16bAdxVal)
    if not anyMet and enableLB16c
        if checkRange(0, rangeLen-1, rsi, lb16cRsiOp, lb16cRsiVal) and checkRange(0, rangeLen-1, vfi, lb16cVfiOp, lb16cVfiVal) and checkRange(0, rangeLen-1, diPos, lb16cAdxOp, lb16cAdxVal)
            anyMet := true
            lBuyReason := "LB16c: RSI" + lb16cRsiOp + str.tostring(lb16cRsiVal) + " VFI" + lb16cVfiOp + str.tostring(lb16cVfiVal) + " DI+" + lb16cAdxOp + str.tostring(lb16cAdxVal)
    if not anyMet and enableLB16d
        if checkRange(0, rangeLen-1, rsi, lb16dRsiOp, lb16dRsiVal) and checkRange(0, rangeLen-1, vfi, lb16dVfiOp, lb16dVfiVal) and checkRange(0, rangeLen-1, diPos, lb16dAdxOp, lb16dAdxVal)
            anyMet := true
            lBuyReason := "LB16d: RSI" + lb16dRsiOp + str.tostring(lb16dRsiVal) + " VFI" + lb16dVfiOp + str.tostring(lb16dVfiVal) + " DI+" + lb16dAdxOp + str.tostring(lb16dAdxVal)

    if anyMet
        lBuySignal := true

var int lLastExitBar = na
if strategy.position_size == 0 and strategy.position_size[1] > 0
    lLastExitBar := bar_index

lBuyBlocked = false
if lBuySignal
    if lbbUseSale and not na(lLastExitBar) and (bar_index - lLastExitBar) <= lbbSaleBars
        lBuyBlocked := true
    if lbbUseRsi and not lBuyBlocked
        if checkRange(0, lbbRsiBars - 1, rsi, lbbRsiOp, lbbRsiVal)
            lBuyBlocked := true
    if lbbUseVfi and not lBuyBlocked
        if checkRange(0, lbbVfiBars - 1, vfi, lbbVfiOp, lbbVfiVal)
            lBuyBlocked := true

var float lEntryPrice = na
var int   lEntryBar   = na   // ← НОВАЯ ПЕРЕМЕННАЯ: бар входа в Лонг
var bool  longIsOpen  = false  // ← INDEPENDENT TRACKING: Лонг позиция открыта
var float sEntryPrice = na
var int   sEntryBar   = na   // ← НОВАЯ ПЕРЕМЕННАЯ: бар входа в Шорт
var bool  shortIsOpen = false  // ← INDEPENDENT TRACKING: Шорт позиция открыта

if lBuySignal and not lBuyBlocked and strategy.equity > 0
    // Проверка пивот-фильтра для входа в лонг (если включён)
    pivotEntryOk = true
    if usePivotFilterLongEntry
        searchFrom = na(lEntryBar) ? bar_index - 50 : lEntryBar  // Fallback для первого входа
        [pivotFound, pivotExpl] = pivotPatternDetector(pivotLongEntryFirst, pivotLongEntrySecond, pivotLongEntryWinBack, pivotLongEntryWinFwd, searchFrom)
        if pivotFound
            pivotDetectorResult := "Long Entry: " + pivotExpl
        else
            pivotEntryOk := false
            
    if pivotEntryOk
        // Флип: закрываем противоположную позицию если allowFlip = true
        if allowFlip and shortIsOpen
            // Calculate P/L before closing
            profitPct = (not na(sEntryPrice) and sEntryPrice > 0) ? ((sEntryPrice - close) / sEntryPrice * 100) : 0.0
            lblColor  = profitPct >= 0 ? color.new(color.green, 10) : color.new(color.red, 10)
            strategy.close("Short", comment="Закрыт при входе в Лонг (Flip)")
            shortIsOpen := false
            if showLabels
                label.new(bar_index, high,
                          "ЗАКРЫТИЕ ШОРТ (Flip)\nP/L: " + (profitPct >= 0 ? "+" : "") + str.tostring(profitPct, "#.##") + "%",
                          color=lblColor, textcolor=color.white,
                          style=label.style_label_down, size=size.small)
        
        // Открываем лонг только если он не открыт (если allowFlip=false) или всегда (если allowFlip=true)
        if not longIsOpen or allowFlip
            strategy.entry("Long", strategy.long)
            longIsOpen := true
            lEntryPrice := close
            lEntryBar   := bar_index   // ← ЗАПОМИНАЕМ БАР ВХОДА
            if showLabels
                label.new(bar_index, low,
                          "ПОКУПКА\n" + lBuyReason + "\nЦена: " + str.tostring(close, "#.##"),
                          color=color.green, textcolor=color.white,
                          style=label.style_label_up, size=size.normal)

// ═══════════════════════════════════════════════════════════════════════════
// ЛОГИКА ПРОДАЖИ (ЛОНГ)
// ═══════════════════════════════════════════════════════════════════════════

var float  lTrailStop  = na
var bool   lStopActive = false
var string lSellReason = ""

var int   lPhase       = 0
var int   lSignalBar   = na
var bool  lHhFound     = false
var float lHhVal       = na
var float lPivotRef    = na

// ── ПРЯМАЯ ПРОДАЖА ЛОНГ LSD1–LSD3 ────────────────────────────────────────
// ← ЗАЩИТА: проверяем bar_index > lEntryBar — запрещаем продажу в баре входа
if strategy.position_size > 0 and lPhase == 0 and not lStopActive and (na(lEntryBar) or bar_index > lEntryBar)
    directSellMet = false
    directSellRsn = ""
    if not directSellMet and enableLSD1
        if checkRange(0, signalWindowLong, rsi, lsd1RsiOp, lsd1RsiVal)
            directSellMet := true
            directSellRsn := "LSD1: RSI" + lsd1RsiOp + str.tostring(lsd1RsiVal)
    if not directSellMet and enableLSD2
        if checkRange(0, signalWindowLong, vfi, lsd2VfiOp, lsd2VfiVal)
            directSellMet := true
            directSellRsn := "LSD2: VFI" + lsd2VfiOp + str.tostring(lsd2VfiVal)
    if not directSellMet and enableLSD3
        if checkRange(0, signalWindowLong, diPos, lsd3DiOp, lsd3DiVal)
            directSellMet := true
            directSellRsn := "LSD3: DI+" + lsd3DiOp + str.tostring(lsd3DiVal)
    if directSellMet
        lSellReason := directSellRsn
        lTrailStop  := low[1]  // Changed from close[1] to low[1] for long trailing stop
        lStopActive := true
        if showLabels
            label.new(bar_index, high,
                      "ПРЯМАЯ ПРОДАЖА\n" + directSellRsn,
                      color=color.purple, textcolor=color.white,
                      style=label.style_label_down, size=size.small)

// ── ОСНОВНАЯ ПРОДАЖА ЛОНГ LS1–LS16 ───────────────────────────────────────
lSellMet    = false
lCurSellRsn = ""

// ← ЗАЩИТА: проверяем bar_index > lEntryBar — запрещаем продажу в баре входа
if strategy.position_size > 0 and lPhase == 0 and not lStopActive and (na(lEntryBar) or bar_index > lEntryBar)
    if not lSellMet and enableLS1
        if checkRange(0, signalWindowLong, rsi, ls1RsiOp, ls1RsiVal) and checkRange(0, signalWindowLong, vfi, ls1VfiOp, ls1VfiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS1: RSI" + ls1RsiOp + str.tostring(ls1RsiVal) + " VFI" + ls1VfiOp + str.tostring(ls1VfiVal)
    if not lSellMet and enableLS2
        if checkRange(0, signalWindowLong, rsi, ls2RsiOp, ls2RsiVal) and checkRange(0, signalWindowLong, vfi, ls2VfiOp, ls2VfiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS2: RSI" + ls2RsiOp + str.tostring(ls2RsiVal) + " VFI" + ls2VfiOp + str.tostring(ls2VfiVal)
    if not lSellMet and enableLS3
        if checkRange(0, signalWindowLong, rsi, ls3RsiOp, ls3RsiVal) and checkRange(0, signalWindowLong, vfi, ls3VfiOp, ls3VfiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS3: RSI" + ls3RsiOp + str.tostring(ls3RsiVal) + " VFI" + ls3VfiOp + str.tostring(ls3VfiVal)
    if not lSellMet and enableLS4
        if checkRange(0, signalWindowLong, rsi, ls4RsiOp, ls4RsiVal) and checkRange(0, signalWindowLong, vfi, ls4VfiOp, ls4VfiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS4: RSI" + ls4RsiOp + str.tostring(ls4RsiVal) + " VFI" + ls4VfiOp + str.tostring(ls4VfiVal)
    if not lSellMet and enableLS5
        if checkRange(0, signalWindowLong, rsi, ls5RsiOp, ls5RsiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS5: RSI" + ls5RsiOp + str.tostring(ls5RsiVal)
    if not lSellMet and enableLS6
        if checkRange(0, signalWindowLong, rsi, ls6RsiOp, ls6RsiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS6: RSI" + ls6RsiOp + str.tostring(ls6RsiVal)
    if not lSellMet and enableLS7
        if checkRange(0, signalWindowLong, rsi, ls7RsiOp, ls7RsiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS7: RSI" + ls7RsiOp + str.tostring(ls7RsiVal)
    if not lSellMet and enableLS8
        if checkRange(0, signalWindowLong, rsi, ls8RsiOp, ls8RsiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS8: RSI" + ls8RsiOp + str.tostring(ls8RsiVal)
    if not lSellMet and enableLS9
        if checkRange(0, signalWindowLong, vfi, ls9VfiOp, ls9VfiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS9: VFI" + ls9VfiOp + str.tostring(ls9VfiVal)
    if not lSellMet and enableLS10
        if checkRange(0, signalWindowLong, vfi, ls10VfiOp, ls10VfiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS10: VFI" + ls10VfiOp + str.tostring(ls10VfiVal)
    if not lSellMet and enableLS11
        if checkRange(0, signalWindowLong, vfi, ls11VfiOp, ls11VfiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS11: VFI" + ls11VfiOp + str.tostring(ls11VfiVal)
    if not lSellMet and enableLS12
        if checkRange(0, signalWindowLong, vfi, ls12VfiOp, ls12VfiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS12: VFI" + ls12VfiOp + str.tostring(ls12VfiVal)
    if not lSellMet and enableLS13
        if checkRange(0, signalWindowLong, diPos, ls13DiOp, ls13DiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS13a: DI+" + ls13DiOp + str.tostring(ls13DiVal)
    if not lSellMet and enableLS13b
        if checkRange(0, signalWindowLong, diPos, ls13bDiOp, ls13bDiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS13b: DI+" + ls13bDiOp + str.tostring(ls13bDiVal)
    if not lSellMet and enableLS14
        if checkRange(0, signalWindowLong, rsi, ls14RsiOp, ls14RsiVal) and checkRange(0, signalWindowLong, diPos, ls14DiOp, ls14DiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS14a: RSI" + ls14RsiOp + str.tostring(ls14RsiVal) + " DI+" + ls14DiOp + str.tostring(ls14DiVal)
    if not lSellMet and enableLS14b
        if checkRange(0, signalWindowLong, rsi, ls14bRsiOp, ls14bRsiVal) and checkRange(0, signalWindowLong, diPos, ls14bDiOp, ls14bDiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS14b: RSI" + ls14bRsiOp + str.tostring(ls14bRsiVal) + " DI+" + ls14bDiOp + str.tostring(ls14bDiVal)
    if not lSellMet and enableLS14c
        if checkRange(0, signalWindowLong, rsi, ls14cRsiOp, ls14cRsiVal) and checkRange(0, signalWindowLong, diPos, ls14cDiOp, ls14cDiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS14c: RSI" + ls14cRsiOp + str.tostring(ls14cRsiVal) + " DI+" + ls14cDiOp + str.tostring(ls14cDiVal)
    if not lSellMet and enableLS14d
        if checkRange(0, signalWindowLong, rsi, ls14dRsiOp, ls14dRsiVal) and checkRange(0, signalWindowLong, diPos, ls14dDiOp, ls14dDiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS14d: RSI" + ls14dRsiOp + str.tostring(ls14dRsiVal) + " DI+" + ls14dDiOp + str.tostring(ls14dDiVal)
    if not lSellMet and enableLS15
        if checkRange(0, signalWindowLong, vfi, ls15VfiOp, ls15VfiVal) and checkRange(0, signalWindowLong, diPos, ls15DiOp, ls15DiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS15a: VFI" + ls15VfiOp + str.tostring(ls15VfiVal) + " DI+" + ls15DiOp + str.tostring(ls15DiVal)
    if not lSellMet and enableLS15b
        if checkRange(0, signalWindowLong, vfi, ls15bVfiOp, ls15bVfiVal) and checkRange(0, signalWindowLong, diPos, ls15bDiOp, ls15bDiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS15b: VFI" + ls15bVfiOp + str.tostring(ls15bVfiVal) + " DI+" + ls15bDiOp + str.tostring(ls15bDiVal)
    if not lSellMet and enableLS15c
        if checkRange(0, signalWindowLong, vfi, ls15cVfiOp, ls15cVfiVal) and checkRange(0, signalWindowLong, diPos, ls15cDiOp, ls15cDiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS15c: VFI" + ls15cVfiOp + str.tostring(ls15cVfiVal) + " DI+" + ls15cDiOp + str.tostring(ls15cDiVal)
    if not lSellMet and enableLS15d
        if checkRange(0, signalWindowLong, vfi, ls15dVfiOp, ls15dVfiVal) and checkRange(0, signalWindowLong, diPos, ls15dDiOp, ls15dDiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS15d: VFI" + ls15dVfiOp + str.tostring(ls15dVfiVal) + " DI+" + ls15dDiOp + str.tostring(ls15dDiVal)
    if not lSellMet and enableLS16
        if checkRange(0, signalWindowLong, rsi, ls16RsiOp, ls16RsiVal) and checkRange(0, signalWindowLong, vfi, ls16VfiOp, ls16VfiVal) and checkRange(0, signalWindowLong, diPos, ls16DiOp, ls16DiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS16a: RSI" + ls16RsiOp + str.tostring(ls16RsiVal) + " VFI" + ls16VfiOp + str.tostring(ls16VfiVal) + " DI+" + ls16DiOp + str.tostring(ls16DiVal)
    if not lSellMet and enableLS16b
        if checkRange(0, signalWindowLong, rsi, ls16bRsiOp, ls16bRsiVal) and checkRange(0, signalWindowLong, vfi, ls16bVfiOp, ls16bVfiVal) and checkRange(0, signalWindowLong, diPos, ls16bDiOp, ls16bDiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS16b: RSI" + ls16bRsiOp + str.tostring(ls16bRsiVal) + " VFI" + ls16bVfiOp + str.tostring(ls16bVfiVal) + " DI+" + ls16bDiOp + str.tostring(ls16bDiVal)
    if not lSellMet and enableLS16c
        if checkRange(0, signalWindowLong, rsi, ls16cRsiOp, ls16cRsiVal) and checkRange(0, signalWindowLong, vfi, ls16cVfiOp, ls16cVfiVal) and checkRange(0, signalWindowLong, diPos, ls16cDiOp, ls16cDiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS16c: RSI" + ls16cRsiOp + str.tostring(ls16cRsiVal) + " VFI" + ls16cVfiOp + str.tostring(ls16cVfiVal) + " DI+" + ls16cDiOp + str.tostring(ls16cDiVal)
    if not lSellMet and enableLS16d
        if checkRange(0, signalWindowLong, rsi, ls16dRsiOp, ls16dRsiVal) and checkRange(0, signalWindowLong, vfi, ls16dVfiOp, ls16dVfiVal) and checkRange(0, signalWindowLong, diPos, ls16dDiOp, ls16dDiVal)
            lSellMet := true
            lSignalBar := bar_index
            lCurSellRsn := "LS16d: RSI" + ls16dRsiOp + str.tostring(ls16dRsiVal) + " VFI" + ls16dVfiOp + str.tostring(ls16dVfiVal) + " DI+" + ls16dDiOp + str.tostring(ls16dDiVal)

    if lSellMet
        lSellReason := lCurSellRsn
        if usePivotFilterLongExit
            lPhase    := 2
            lHhFound  := false
            lPivotRef := ta.valuewhen(not na(ph), ph, 0)
        else
            lTrailStop  := low[1]  // Changed from close[1] to low[1] for long trailing stop
            lStopActive := true

if strategy.position_size > 0 and lPhase == 2
    searchStart    = lSignalBar
    barsFromSearch = bar_index - searchStart
    
    // Use new pivot pattern detector for long exit
    [pivotFound, pivotExpl] = pivotPatternDetector(pivotLongExitFirst, pivotLongExitSecond, pivotLongExitWinBack, pivotLongExitWinFwd, searchStart)
    
    if pivotFound
        pivotDetectorResult := "Long Exit: " + pivotExpl
        lTrailStop  := low[1]  // Changed from close[1] to low[1] for long trailing stop
        lStopActive := true
        lPhase      := 0
        lHhFound    := false
    
    if barsFromSearch > (pivotLongExitWinBack + pivotLongExitWinFwd)
        lPhase   := 0
        lHhFound := false

if lStopActive and strategy.position_size > 0
    // Move stop up only (never down) using low[1]
    if close > close[1]
        lTrailStop := math.max(lTrailStop, low[1])
    if close < lTrailStop
        profitPct = (not na(lEntryPrice) and lEntryPrice > 0) ? ((close - lEntryPrice) / lEntryPrice * 100) : 0.0  // Fixed P/L calculation
        lblColor  = profitPct >= 0 ? color.new(color.green, 10) : color.new(color.red, 10)
        strategy.close("Long", comment="Стоп Лонг")
        longIsOpen := false  // Mark long as closed
        if showLabels
            label.new(bar_index, high,
                      "ПРОДАЖА ЛОНГ\n" + lSellReason +
                      "\nЦена: "  + str.tostring(close, "#.##") +
                      "\nВход: "  + str.tostring(lEntryPrice, "#.##") +
                      "\nP/L: "   + (profitPct >= 0 ? "+" : "") + str.tostring(profitPct, "#.##") + "%",
                      color=lblColor, textcolor=color.white,
                      style=label.style_label_down, size=size.normal)
        lStopActive := false
        lTrailStop  := na
        lPhase      := 0
        lBuyReason  := ""    // Reset reason string
        lSellReason := ""    // Reset reason string

// Сброс при отсутствии лонг-позиции
if strategy.position_size <= 0
    longIsOpen  := false
    lStopActive := false
    lTrailStop  := na
    lPhase      := 0
    lHhFound    := false
    lSignalBar  := na
    lEntryPrice := na
    lEntryBar   := na   // ← СБРОС БАРА ВХОДА
    lBuyReason  := ""   // Reset reason string
    lSellReason := ""   // Reset reason string

// ═══════════════════════════════════════════════════════════════════════════
// ЛОГИКА ШОРТА
// ═══════════════════════════════════════════════════════════════════════════

var string sEntryReason = ""
sEntrySignal = false

if enableShort and isFirstRedAfterGreen and strategy.position_size == 0
    rangeLen = greenCount[1] + 1
    anyMet   = false

    if not anyMet and enableSB1
        if checkRange(0, rangeLen-1, rsi, sb1RsiOp, sb1RsiVal) and checkRange(0, rangeLen-1, vfi, sb1VfiOp, sb1VfiVal)
            anyMet := true
            sEntryReason := "SB1: RSI" + sb1RsiOp + str.tostring(sb1RsiVal) + " VFI" + sb1VfiOp + str.tostring(sb1VfiVal)
    if not anyMet and enableSB2
        if checkRange(0, rangeLen-1, rsi, sb2RsiOp, sb2RsiVal) and checkRange(0, rangeLen-1, vfi, sb2VfiOp, sb2VfiVal)
            anyMet := true
            sEntryReason := "SB2: RSI" + sb2RsiOp + str.tostring(sb2RsiVal) + " VFI" + sb2VfiOp + str.tostring(sb2VfiVal)
    if not anyMet and enableSB3
        if checkRange(0, rangeLen-1, rsi, sb3RsiOp, sb3RsiVal) and checkRange(0, rangeLen-1, vfi, sb3VfiOp, sb3VfiVal)
            anyMet := true
            sEntryReason := "SB3: RSI" + sb3RsiOp + str.tostring(sb3RsiVal) + " VFI" + sb3VfiOp + str.tostring(sb3VfiVal)
    if not anyMet and enableSB4
        if checkRange(0, rangeLen-1, rsi, sb4RsiOp, sb4RsiVal) and checkRange(0, rangeLen-1, vfi, sb4VfiOp, sb4VfiVal)
            anyMet := true
            sEntryReason := "SB4: RSI" + sb4RsiOp + str.tostring(sb4RsiVal) + " VFI" + sb4VfiOp + str.tostring(sb4VfiVal)
    if not anyMet and enableSB5
        if checkRange(0, rangeLen-1, rsi, sb5RsiOp, sb5RsiVal)
            anyMet := true
            sEntryReason := "SB5: RSI" + sb5RsiOp + str.tostring(sb5RsiVal)
    if not anyMet and enableSB6
        if checkRange(0, rangeLen-1, rsi, sb6RsiOp, sb6RsiVal)
            anyMet := true
            sEntryReason := "SB6: RSI" + sb6RsiOp + str.tostring(sb6RsiVal)
    if not anyMet and enableSB7
        if checkRange(0, rangeLen-1, rsi, sb7RsiOp, sb7RsiVal)
            anyMet := true
            sEntryReason := "SB7: RSI" + sb7RsiOp + str.tostring(sb7RsiVal)
    if not anyMet and enableSB8
        if checkRange(0, rangeLen-1, rsi, sb8RsiOp, sb8RsiVal)
            anyMet := true
            sEntryReason := "SB8: RSI" + sb8RsiOp + str.tostring(sb8RsiVal)
    if not anyMet and enableSB9
        if checkRange(0, rangeLen-1, vfi, sb9VfiOp, sb9VfiVal)
            anyMet := true
            sEntryReason := "SB9: VFI" + sb9VfiOp + str.tostring(sb9VfiVal)
    if not anyMet and enableSB10
        if checkRange(0, rangeLen-1, vfi, sb10VfiOp, sb10VfiVal)
            anyMet := true
            sEntryReason := "SB10: VFI" + sb10VfiOp + str.tostring(sb10VfiVal)
    if not anyMet and enableSB11
        if checkRange(0, rangeLen-1, vfi, sb11VfiOp, sb11VfiVal)
            anyMet := true
            sEntryReason := "SB11: VFI" + sb11VfiOp + str.tostring(sb11VfiVal)
    if not anyMet and enableSB12
        if checkRange(0, rangeLen-1, vfi, sb12VfiOp, sb12VfiVal)
            anyMet := true
            sEntryReason := "SB12: VFI" + sb12VfiOp + str.tostring(sb12VfiVal)
    if not anyMet and enableSB13
        if checkRange(0, rangeLen-1, diPos, sb13AdxOp, sb13AdxVal)
            anyMet := true
            sEntryReason := "SB13a: DI+" + sb13AdxOp + str.tostring(sb13AdxVal)
    if not anyMet and enableSB13b
        if checkRange(0, rangeLen-1, diPos, sb13bAdxOp, sb13bAdxVal)
            anyMet := true
            sEntryReason := "SB13b: DI+" + sb13bAdxOp + str.tostring(sb13bAdxVal)
    if not anyMet and enableSB14
        if checkRange(0, rangeLen-1, rsi, sb14RsiOp, sb14RsiVal) and checkRange(0, rangeLen-1, diPos, sb14AdxOp, sb14AdxVal)
            anyMet := true
            sEntryReason := "SB14a: RSI" + sb14RsiOp + str.tostring(sb14RsiVal) + " DI+" + sb14AdxOp + str.tostring(sb14AdxVal)
    if not anyMet and enableSB14b
        if checkRange(0, rangeLen-1, rsi, sb14bRsiOp, sb14bRsiVal) and checkRange(0, rangeLen-1, diPos, sb14bAdxOp, sb14bAdxVal)
            anyMet := true
            sEntryReason := "SB14b: RSI" + sb14bRsiOp + str.tostring(sb14bRsiVal) + " DI+" + sb14bAdxOp + str.tostring(sb14bAdxVal)
    if not anyMet and enableSB14c
        if checkRange(0, rangeLen-1, rsi, sb14cRsiOp, sb14cRsiVal) and checkRange(0, rangeLen-1, diPos, sb14cAdxOp, sb14cAdxVal)
            anyMet := true
            sEntryReason := "SB14c: RSI" + sb14cRsiOp + str.tostring(sb14cRsiVal) + " DI+" + sb14cAdxOp + str.tostring(sb14cAdxVal)
    if not anyMet and enableSB14d
        if checkRange(0, rangeLen-1, rsi, sb14dRsiOp, sb14dRsiVal) and checkRange(0, rangeLen-1, diPos, sb14dAdxOp, sb14dAdxVal)
            anyMet := true
            sEntryReason := "SB14d: RSI" + sb14dRsiOp + str.tostring(sb14dRsiVal) + " DI+" + sb14dAdxOp + str.tostring(sb14dAdxVal)
    if not anyMet and enableSB15
        if checkRange(0, rangeLen-1, vfi, sb15VfiOp, sb15VfiVal) and checkRange(0, rangeLen-1, diPos, sb15AdxOp, sb15AdxVal)
            anyMet := true
            sEntryReason := "SB15a: VFI" + sb15VfiOp + str.tostring(sb15VfiVal) + " DI+" + sb15AdxOp + str.tostring(sb15AdxVal)
    if not anyMet and enableSB15b
        if checkRange(0, rangeLen-1, vfi, sb15bVfiOp, sb15bVfiVal) and checkRange(0, rangeLen-1, diPos, sb15bAdxOp, sb15bAdxVal)
            anyMet := true
            sEntryReason := "SB15b: VFI" + sb15bVfiOp + str.tostring(sb15bVfiVal) + " DI+" + sb15bAdxOp + str.tostring(sb15bAdxVal)
    if not anyMet and enableSB15c
        if checkRange(0, rangeLen-1, vfi, sb15cVfiOp, sb15cVfiVal) and checkRange(0, rangeLen-1, diPos, sb15cAdxOp, sb15cAdxVal)
            anyMet := true
            sEntryReason := "SB15c: VFI" + sb15cVfiOp + str.tostring(sb15cVfiVal) + " DI+" + sb15cAdxOp + str.tostring(sb15cAdxVal)
    if not anyMet and enableSB15d
        if checkRange(0, rangeLen-1, vfi, sb15dVfiOp, sb15dVfiVal) and checkRange(0, rangeLen-1, diPos, sb15dAdxOp, sb15dAdxVal)
            anyMet := true
            sEntryReason := "SB15d: VFI" + sb15dVfiOp + str.tostring(sb15dVfiVal) + " DI+" + sb15dAdxOp + str.tostring(sb15dAdxVal)
    if not anyMet and enableSB16
        if checkRange(0, rangeLen-1, rsi, sb16RsiOp, sb16RsiVal) and checkRange(0, rangeLen-1, vfi, sb16VfiOp, sb16VfiVal) and checkRange(0, rangeLen-1, diPos, sb16AdxOp, sb16AdxVal)
            anyMet := true
            sEntryReason := "SB16a: RSI" + sb16RsiOp + str.tostring(sb16RsiVal) + " VFI" + sb16VfiOp + str.tostring(sb16VfiVal) + " DI+" + sb16AdxOp + str.tostring(sb16AdxVal)
    if not anyMet and enableSB16b
        if checkRange(0, rangeLen-1, rsi, sb16bRsiOp, sb16bRsiVal) and checkRange(0, rangeLen-1, vfi, sb16bVfiOp, sb16bVfiVal) and checkRange(0, rangeLen-1, diPos, sb16bAdxOp, sb16bAdxVal)
            anyMet := true
            sEntryReason := "SB16b: RSI" + sb16bRsiOp + str.tostring(sb16bRsiVal) + " VFI" + sb16bVfiOp + str.tostring(sb16bVfiVal) + " DI+" + sb16bAdxOp + str.tostring(sb16bAdxVal)
    if not anyMet and enableSB16c
        if checkRange(0, rangeLen-1, rsi, sb16cRsiOp, sb16cRsiVal) and checkRange(0, rangeLen-1, vfi, sb16cVfiOp, sb16cVfiVal) and checkRange(0, rangeLen-1, diPos, sb16cAdxOp, sb16cAdxVal)
            anyMet := true
            sEntryReason := "SB16c: RSI" + sb16cRsiOp + str.tostring(sb16cRsiVal) + " VFI" + sb16cVfiOp + str.tostring(sb16cVfiVal) + " DI+" + sb16cAdxOp + str.tostring(sb16cAdxVal)
    if not anyMet and enableSB16d
        if checkRange(0, rangeLen-1, rsi, sb16dRsiOp, sb16dRsiVal) and checkRange(0, rangeLen-1, vfi, sb16dVfiOp, sb16dVfiVal) and checkRange(0, rangeLen-1, diPos, sb16dAdxOp, sb16dAdxVal)
            anyMet := true
            sEntryReason := "SB16d: RSI" + sb16dRsiOp + str.tostring(sb16dRsiVal) + " VFI" + sb16dVfiOp + str.tostring(sb16dVfiVal) + " DI+" + sb16dAdxOp + str.tostring(sb16dAdxVal)

    if anyMet
        sEntrySignal := true

var int sLastExitBar = na
if strategy.position_size == 0 and strategy.position_size[1] < 0
    sLastExitBar := bar_index

sEntryBlocked = false
if sEntrySignal
    if sbbUseSale and not na(sLastExitBar) and (bar_index - sLastExitBar) <= sbbSaleBars
        sEntryBlocked := true
    if sbbUseRsi and not sEntryBlocked
        if checkRange(0, sbbRsiBars - 1, rsi, sbbRsiOp, sbbRsiVal)
            sEntryBlocked := true
    if sbbUseVfi and not sEntryBlocked
        if checkRange(0, sbbVfiBars - 1, vfi, sbbVfiOp, sbbVfiVal)
            sEntryBlocked := true

if sEntrySignal and not sEntryBlocked and strategy.equity > 0
    pivotEntryOk = true
    if usePivotFilterShortEntry
        searchFrom = na(sEntryBar) ? bar_index - 50 : sEntryBar  // Fallback для первого входа
        [pivotFound, pivotExpl] = pivotPatternDetector(pivotShortEntryFirst, pivotShortEntrySecond, pivotShortEntryWinBack, pivotShortEntryWinFwd, searchFrom)
        if pivotFound
            pivotDetectorResult := "Short Entry: " + pivotExpl
        else
            pivotEntryOk := false
            
    if pivotEntryOk
        // Флип: закрываем противоположную позицию если allowFlip = true
        if allowFlip and longIsOpen
            // Calculate P/L before closing
            profitPct = (not na(lEntryPrice) and lEntryPrice > 0) ? ((close - lEntryPrice) / lEntryPrice * 100) : 0.0
            lblColor  = profitPct >= 0 ? color.new(color.green, 10) : color.new(color.red, 10)
            strategy.close("Long", comment="Закрыт при входе в Шорт (Flip)")
            longIsOpen := false
            if showLabels
                label.new(bar_index, low,
                          "ЗАКРЫТИЕ ЛОНГ (Flip)\nP/L: " + (profitPct >= 0 ? "+" : "") + str.tostring(profitPct, "#.##") + "%",
                          color=lblColor, textcolor=color.white,
                          style=label.style_label_up, size=size.small)
        
        // Открываем шорт только если он не открыт (если allowFlip=false) или всегда (если allowFlip=true)
        if not shortIsOpen or allowFlip
            strategy.entry("Short", strategy.short)
            shortIsOpen := true
            sEntryPrice := close
            sEntryBar   := bar_index   // ← ЗАПОМИНАЕМ БАР ВХОДА
            if showLabels
                label.new(bar_index, high,
                          "ШОРТ\n" + sEntryReason + "\nЦена: " + str.tostring(close, "#.##"),
                          color=color.red, textcolor=color.white,
                          style=label.style_label_down, size=size.normal)

// ═══════════════════════════════════════════════════════════════════════════
// ЛОГИКА ЗАКРЫТИЯ ШОРТА
// ═══════════════════════════════════════════════════════════════════════════

var float  sTrailStop   = na
var bool   sStopActive  = false
var string sCloseReason = ""

var int   sPhase       = 0
var int   sSignalBar   = na
var bool  sLlFound     = false
var float sLlVal       = na
var float sPivotRefL   = na

// ── ПРЯМОЕ ЗАКРЫТИЕ ШОРТА SSD1–SSD3 ─────────────────────────────────────
// ← ЗАЩИТА: проверяем bar_index > sEntryBar — запрещаем закрытие в баре входа
if strategy.position_size < 0 and sPhase == 0 and not sStopActive and (na(sEntryBar) or bar_index > sEntryBar)
    directCloseMet = false
    directCloseRsn = ""
    if not directCloseMet and enableSSD1
        if checkRange(0, signalWindowShort, rsi, ssd1RsiOp, ssd1RsiVal)
            directCloseMet := true
            directCloseRsn := "SSD1: RSI" + ssd1RsiOp + str.tostring(ssd1RsiVal)
    if not directCloseMet and enableSSD2
        if checkRange(0, signalWindowShort, vfi, ssd2VfiOp, ssd2VfiVal)
            directCloseMet := true
            directCloseRsn := "SSD2: VFI" + ssd2VfiOp + str.tostring(ssd2VfiVal)
    if not directCloseMet and enableSSD3
        if checkRange(0, signalWindowShort, diPos, ssd3DiOp, ssd3DiVal)
            directCloseMet := true
            directCloseRsn := "SSD3: DI+" + ssd3DiOp + str.tostring(ssd3DiVal)
    if directCloseMet
        sCloseReason := directCloseRsn
        sTrailStop   := high[1]  // Changed from close[1] to high[1] for short trailing stop
        sStopActive  := true
        if showLabels
            label.new(bar_index, low,
                      "ПРЯМОЕ ЗАКРЫТИЕ ШОРТА\n" + directCloseRsn,
                      color=color.purple, textcolor=color.white,
                      style=label.style_label_up, size=size.small)

// ── ОСНОВНОЕ ЗАКРЫТИЕ ШОРТА SS1–SS16 ─────────────────────────────────────
sCloseMet    = false
sCurCloseRsn = ""

// ← ЗАЩИТА: проверяем bar_index > sEntryBar — запрещаем закрытие в баре входа
if strategy.position_size < 0 and sPhase == 0 and not sStopActive and (na(sEntryBar) or bar_index > sEntryBar)
    if not sCloseMet and enableSS1
        if checkRange(0, signalWindowShort, rsi, ss1RsiOp, ss1RsiVal) and checkRange(0, signalWindowShort, vfi, ss1VfiOp, ss1VfiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS1: RSI" + ss1RsiOp + str.tostring(ss1RsiVal) + " VFI" + ss1VfiOp + str.tostring(ss1VfiVal)
    if not sCloseMet and enableSS2
        if checkRange(0, signalWindowShort, rsi, ss2RsiOp, ss2RsiVal) and checkRange(0, signalWindowShort, vfi, ss2VfiOp, ss2VfiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS2: RSI" + ss2RsiOp + str.tostring(ss2RsiVal) + " VFI" + ss2VfiOp + str.tostring(ss2VfiVal)
    if not sCloseMet and enableSS3
        if checkRange(0, signalWindowShort, rsi, ss3RsiOp, ss3RsiVal) and checkRange(0, signalWindowShort, vfi, ss3VfiOp, ss3VfiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS3: RSI" + ss3RsiOp + str.tostring(ss3RsiVal) + " VFI" + ss3VfiOp + str.tostring(ss3VfiVal)
    if not sCloseMet and enableSS4
        if checkRange(0, signalWindowShort, rsi, ss4RsiOp, ss4RsiVal) and checkRange(0, signalWindowShort, vfi, ss4VfiOp, ss4VfiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS4: RSI" + ss4RsiOp + str.tostring(ss4RsiVal) + " VFI" + ss4VfiOp + str.tostring(ss4VfiVal)
    if not sCloseMet and enableSS5
        if checkRange(0, signalWindowShort, rsi, ss5RsiOp, ss5RsiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS5: RSI" + ss5RsiOp + str.tostring(ss5RsiVal)
    if not sCloseMet and enableSS6
        if checkRange(0, signalWindowShort, rsi, ss6RsiOp, ss6RsiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS6: RSI" + ss6RsiOp + str.tostring(ss6RsiVal)
    if not sCloseMet and enableSS7
        if checkRange(0, signalWindowShort, rsi, ss7RsiOp, ss7RsiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS7: RSI" + ss7RsiOp + str.tostring(ss7RsiVal)
    if not sCloseMet and enableSS8
        if checkRange(0, signalWindowShort, rsi, ss8RsiOp, ss8RsiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS8: RSI" + ss8RsiOp + str.tostring(ss8RsiVal)
    if not sCloseMet and enableSS9
        if checkRange(0, signalWindowShort, vfi, ss9VfiOp, ss9VfiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS9: VFI" + ss9VfiOp + str.tostring(ss9VfiVal)
    if not sCloseMet and enableSS10
        if checkRange(0, signalWindowShort, vfi, ss10VfiOp, ss10VfiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS10: VFI" + ss10VfiOp + str.tostring(ss10VfiVal)
    if not sCloseMet and enableSS11
        if checkRange(0, signalWindowShort, vfi, ss11VfiOp, ss11VfiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS11: VFI" + ss11VfiOp + str.tostring(ss11VfiVal)
    if not sCloseMet and enableSS12
        if checkRange(0, signalWindowShort, vfi, ss12VfiOp, ss12VfiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS12: VFI" + ss12VfiOp + str.tostring(ss12VfiVal)
    if not sCloseMet and enableSS13
        if checkRange(0, signalWindowShort, diPos, ss13DiOp, ss13DiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS13a: DI+" + ss13DiOp + str.tostring(ss13DiVal)
    if not sCloseMet and enableSS13b
        if checkRange(0, signalWindowShort, diPos, ss13bDiOp, ss13bDiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS13b: DI+" + ss13bDiOp + str.tostring(ss13bDiVal)
    if not sCloseMet and enableSS14
        if checkRange(0, signalWindowShort, rsi, ss14RsiOp, ss14RsiVal) and checkRange(0, signalWindowShort, diPos, ss14DiOp, ss14DiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS14a: RSI" + ss14RsiOp + str.tostring(ss14RsiVal) + " DI+" + ss14DiOp + str.tostring(ss14DiVal)
    if not sCloseMet and enableSS14b
        if checkRange(0, signalWindowShort, rsi, ss14bRsiOp, ss14bRsiVal) and checkRange(0, signalWindowShort, diPos, ss14bDiOp, ss14bDiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS14b: RSI" + ss14bRsiOp + str.tostring(ss14bRsiVal) + " DI+" + ss14bDiOp + str.tostring(ss14bDiVal)
    if not sCloseMet and enableSS14c
        if checkRange(0, signalWindowShort, rsi, ss14cRsiOp, ss14cRsiVal) and checkRange(0, signalWindowShort, diPos, ss14cDiOp, ss14cDiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS14c: RSI" + ss14cRsiOp + str.tostring(ss14cRsiVal) + " DI+" + ss14cDiOp + str.tostring(ss14cDiVal)
    if not sCloseMet and enableSS14d
        if checkRange(0, signalWindowShort, rsi, ss14dRsiOp, ss14dRsiVal) and checkRange(0, signalWindowShort, diPos, ss14dDiOp, ss14dDiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS14d: RSI" + ss14dRsiOp + str.tostring(ss14dRsiVal) + " DI+" + ss14dDiOp + str.tostring(ss14dDiVal)
    if not sCloseMet and enableSS15
        if checkRange(0, signalWindowShort, vfi, ss15VfiOp, ss15VfiVal) and checkRange(0, signalWindowShort, diPos, ss15DiOp, ss15DiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS15a: VFI" + ss15VfiOp + str.tostring(ss15VfiVal) + " DI+" + ss15DiOp + str.tostring(ss15DiVal)
    if not sCloseMet and enableSS15b
        if checkRange(0, signalWindowShort, vfi, ss15bVfiOp, ss15bVfiVal) and checkRange(0, signalWindowShort, diPos, ss15bDiOp, ss15bDiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS15b: VFI" + ss15bVfiOp + str.tostring(ss15bVfiVal) + " DI+" + ss15bDiOp + str.tostring(ss15bDiVal)
    if not sCloseMet and enableSS15c
        if checkRange(0, signalWindowShort, vfi, ss15cVfiOp, ss15cVfiVal) and checkRange(0, signalWindowShort, diPos, ss15cDiOp, ss15cDiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS15c: VFI" + ss15cVfiOp + str.tostring(ss15cVfiVal) + " DI+" + ss15cDiOp + str.tostring(ss15cDiVal)
    if not sCloseMet and enableSS15d
        if checkRange(0, signalWindowShort, vfi, ss15dVfiOp, ss15dVfiVal) and checkRange(0, signalWindowShort, diPos, ss15dDiOp, ss15dDiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS15d: VFI" + ss15dVfiOp + str.tostring(ss15dVfiVal) + " DI+" + ss15dDiOp + str.tostring(ss15dDiVal)
    if not sCloseMet and enableSS16
        if checkRange(0, signalWindowShort, rsi, ss16RsiOp, ss16RsiVal) and checkRange(0, signalWindowShort, vfi, ss16VfiOp, ss16VfiVal) and checkRange(0, signalWindowShort, diPos, ss16DiOp, ss16DiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS16a: RSI" + ss16RsiOp + str.tostring(ss16RsiVal) + " VFI" + ss16VfiOp + str.tostring(ss16VfiVal) + " DI+" + ss16DiOp + str.tostring(ss16DiVal)
    if not sCloseMet and enableSS16b
        if checkRange(0, signalWindowShort, rsi, ss16bRsiOp, ss16bRsiVal) and checkRange(0, signalWindowShort, vfi, ss16bVfiOp, ss16bVfiVal) and checkRange(0, signalWindowShort, diPos, ss16bDiOp, ss16bDiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS16b: RSI" + ss16bRsiOp + str.tostring(ss16bRsiVal) + " VFI" + ss16bVfiOp + str.tostring(ss16bVfiVal) + " DI+" + ss16bDiOp + str.tostring(ss16bDiVal)
    if not sCloseMet and enableSS16c
        if checkRange(0, signalWindowShort, rsi, ss16cRsiOp, ss16cRsiVal) and checkRange(0, signalWindowShort, vfi, ss16cVfiOp, ss16cVfiVal) and checkRange(0, signalWindowShort, diPos, ss16cDiOp, ss16cDiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS16c: RSI" + ss16cRsiOp + str.tostring(ss16cRsiVal) + " VFI" + ss16cVfiOp + str.tostring(ss16cVfiVal) + " DI+" + ss16cDiOp + str.tostring(ss16cDiVal)
    if not sCloseMet and enableSS16d
        if checkRange(0, signalWindowShort, rsi, ss16dRsiOp, ss16dRsiVal) and checkRange(0, signalWindowShort, vfi, ss16dVfiOp, ss16dVfiVal) and checkRange(0, signalWindowShort, diPos, ss16dDiOp, ss16dDiVal)
            sCloseMet := true
            sSignalBar := bar_index
            sCurCloseRsn := "SS16d: RSI" + ss16dRsiOp + str.tostring(ss16dRsiVal) + " VFI" + ss16dVfiOp + str.tostring(ss16dVfiVal) + " DI+" + ss16dDiOp + str.tostring(ss16dDiVal)

    if sCloseMet
        sCloseReason := sCurCloseRsn
        if usePivotFilterShortExit
            sPhase      := 2
            sLlFound    := false
            sPivotRefL  := ta.valuewhen(not na(pl), pl, 0)
        else
            sTrailStop  := high[1]  // Changed from close[1] to high[1] for short trailing stop
            sStopActive := true

if strategy.position_size < 0 and sPhase == 2
    searchStart    = sSignalBar
    barsFromSearch = bar_index - searchStart
    
    // Use new pivot pattern detector for short exit
    [pivotFound, pivotExpl] = pivotPatternDetector(pivotShortExitFirst, pivotShortExitSecond, pivotShortExitWinBack, pivotShortExitWinFwd, searchStart)
    
    if pivotFound
        pivotDetectorResult := "Short Exit: " + pivotExpl
        sTrailStop  := high[1]  // Changed from close[1] to high[1] for short trailing stop
        sStopActive := true
        sPhase      := 0
        sLlFound    := false
    
    if barsFromSearch > (pivotShortExitWinBack + pivotShortExitWinFwd)
        sPhase   := 0
        sLlFound := false

if sStopActive and strategy.position_size < 0
    // Move stop down only (never up) using high[1]
    if close < close[1]
        sTrailStop := math.min(sTrailStop, high[1])
    if close > sTrailStop
        profitPct = (not na(sEntryPrice) and sEntryPrice > 0) ? ((sEntryPrice - close) / sEntryPrice * 100) : 0.0  // Fixed P/L calculation
        lblColor  = profitPct >= 0 ? color.new(color.green, 10) : color.new(color.red, 10)
        strategy.close("Short", comment="Стоп Шорт")
        shortIsOpen := false  // Mark short as closed
        if showLabels
            label.new(bar_index, low,
                      "ЗАКРЫТИЕ ШОРТА\n" + sCloseReason +
                      "\nЦена: "  + str.tostring(close, "#.##") +
                      "\nВход: "  + str.tostring(sEntryPrice, "#.##") +
                      "\nP/L: "   + (profitPct >= 0 ? "+" : "") + str.tostring(profitPct, "#.##") + "%",
                      color=lblColor, textcolor=color.white,
                      style=label.style_label_up, size=size.normal)
        sStopActive := false
        sTrailStop  := na
        sPhase      := 0
        sEntryReason := ""     // Reset reason string
        sCloseReason := ""     // Reset reason string

// Сброс при отсутствии шорт-позиции
if strategy.position_size >= 0
    shortIsOpen := false
    sStopActive := false
    sTrailStop  := na
    sPhase      := 0
    sLlFound    := false
    sSignalBar  := na
    sEntryPrice := na
    sEntryBar   := na   // ← СБРОС БАРА ВХОДА
    sEntryReason := ""  // Reset reason string
    sCloseReason := ""  // Reset reason string

// ═══════════════════════════════════════════════════════════════════════════
// ОТОБРАЖЕНИЕ
// ═══════════════════════════════════════════════════════════════════════════

// Трейлинг стопы с увеличенной толщиной линии
plot(lStopActive ? lTrailStop : na, "Стоп Лонг",  color.red,  3, plot.style_linebr)
plot(sStopActive ? sTrailStop : na, "Стоп Шорт",  color.blue, 3, plot.style_linebr)

// Цена входа (жёлтая линия)
entryPrice = strategy.position_size > 0 ? lEntryPrice : strategy.position_size < 0 ? sEntryPrice : na
plot(entryPrice, "Цена входа", color.yellow, 2, plot.style_linebr)

bgColor = strategy.position_size > 0 ? color.new(color.green, 95) : strategy.position_size < 0 ? color.new(color.red, 95) : na
bgcolor(bgColor, title="Позиция")

// ═══════════════════════════════════════════════════════════════════════════
// ТАБЛИЦА
// ═══════════════════════════════════════════════════════════════════════════

if showTable
    var table t = table.new(position.top_right, 2, 18, border_width=1)
    if barstate.islast
        // Заголовки
        table.cell(t, 0, 0, "Параметр",  bgcolor=color.new(color.blue,70), text_color=color.white)
        table.cell(t, 1, 0, "Значение",  bgcolor=color.new(color.blue,70), text_color=color.white)
        
        // RSI с условным форматированием
        rsiBg = rsi < 30 ? color.new(color.red, 60) : rsi > 70 ? color.new(color.green, 60) : color.new(color.gray, 80)
        table.cell(t, 0, 1, "RSI",       text_color=color.white)
        table.cell(t, 1, 1, str.tostring(rsi,  "#.##"), bgcolor=rsiBg, text_color=color.white)
        
        // VFI с условным форматированием
        vfiBg = vfi > 10 ? color.new(color.green, 60) : vfi < -10 ? color.new(color.red, 60) : color.new(color.gray, 80)
        table.cell(t, 0, 2, "VFI",       text_color=color.white)
        table.cell(t, 1, 2, str.tostring(vfi,  "#.##"), bgcolor=vfiBg, text_color=color.white)
        
        // DI+
        table.cell(t, 0, 3, "DI+",       text_color=color.white)
        table.cell(t, 1, 3, str.tostring(diPos,"#.##"), text_color=color.green)
        
        // DI- (новая строка)
        table.cell(t, 0, 4, "DI-",       text_color=color.white)
        table.cell(t, 1, 4, str.tostring(diNeg,"#.##"), text_color=color.red)
        
        // ADX
        table.cell(t, 0, 5, "ADX",       text_color=color.white)
        table.cell(t, 1, 5, str.tostring(adx,  "#.##"), text_color=color.white)
        
        // Позиция
        table.cell(t, 0, 6, "Позиция",   text_color=color.white)
        posText  = strategy.position_size > 0 ? "LONG" : strategy.position_size < 0 ? "SHORT" : "НЕТ"
        posBg    = strategy.position_size > 0 ? color.new(color.green,60) : strategy.position_size < 0 ? color.new(color.red,60) : color.new(color.gray,60)
        table.cell(t, 1, 6, posText, bgcolor=posBg, text_color=color.white)
        
        // Цена входа
        table.cell(t, 0, 7, "Цена входа", text_color=color.white)
        entryPriceText = strategy.position_size > 0 ? str.tostring(lEntryPrice, "#.##") : strategy.position_size < 0 ? str.tostring(sEntryPrice, "#.##") : "—"
        table.cell(t, 1, 7, entryPriceText, text_color=color.yellow)
        
        
        // Причина входа
        table.cell(t, 0, 9, "Причина входа", text_color=color.white)
        entryReasonText = strategy.position_size > 0 ? lBuyReason : strategy.position_size < 0 ? sEntryReason : "—"
        table.cell(t, 1, 9, entryReasonText, text_color=color.white)
        
        // Причина выхода
        table.cell(t, 0, 10, "Причина выхода", text_color=color.white)
        exitReasonText = strategy.position_size > 0 ? lSellReason : strategy.position_size < 0 ? sCloseReason : "—"
        table.cell(t, 1, 10, exitReasonText, text_color=color.white)
        
        // Красных подряд
        table.cell(t, 0, 11, "Красных подряд", text_color=color.white)
        table.cell(t, 1, 11, str.tostring(redCount), text_color=color.red)
        
        // Зелёных подряд
        table.cell(t, 0, 12, "Зелёных подряд", text_color=color.white)
        table.cell(t, 1, 12, str.tostring(greenCount), text_color=color.green)
        
        // Бары в позиции
        table.cell(t, 0, 13, "Бары в позиции", text_color=color.white)
        table.cell(t, 1, 13, str.tostring(barsInPosition), text_color=color.white)
        
        // Pivot Detector Result
        table.cell(t, 0, 14, "Pivot Pattern", text_color=color.white)
        table.cell(t, 1, 14, pivotDetectorResult != "" ? pivotDetectorResult : "—", text_color=color.orange)
        
        // Фазы
        table.cell(t, 0, 15, "Фаза L",    text_color=color.white)
        table.cell(t, 1, 15, str.tostring(lPhase), text_color=color.white)
        table.cell(t, 0, 16, "Фаза S",    text_color=color.white)
        table.cell(t, 1, 16, str.tostring(sPhase), text_color=color.white)
        
        // Стопы
        table.cell(t, 0, 17, strategy.position_size > 0 ? "Стоп L" : "Стоп S",    text_color=color.white)
        stopText = strategy.position_size > 0 and lStopActive ? str.tostring(lTrailStop,"#.##") : strategy.position_size < 0 and sStopActive ? str.tostring(sTrailStop,"#.##") : "—"
        stopColor = strategy.position_size > 0 ? color.red : color.blue
        table.cell(t, 1, 17, stopText, text_color=stopColor)
